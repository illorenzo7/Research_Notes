% document type and language
\documentclass[12pt]{article}

% standard packages
\usepackage{amsmath, bm, empheq, mathrsfs, natbib, cancel}
% label equations by section first, then equation in that section
\numberwithin{equation}{section}

% normal margins
\usepackage[margin=1in]{geometry}

% plane blue hyperlinks
\usepackage[colorlinks]{hyperref}
\hypersetup{
	colorlinks = true,
	linkcolor=blue,
	urlcolor=blue,
	citecolor=blue
}

% common macros
\input{../macros.tex}

% other macros
\newcommand{\nad}{n_{\rm{ad}}}
\newcommand{\dimm}{_{\rm{dim}}}
\newcommand{\cz}{_{\rm{CZ}}}
\newcommand{\rz}{_{\rm{RZ}}}
% date, author, title
\date{\today}
\author{Loren Matilsky}
\title{Non-Dimensionalization of an Anelastic Stable--Unstable Layer in {\rayleigh}}

%\allowdisplaybreaks
\begin{document}
	\maketitle
	\section{General Equations Solved in {\rayleigh}}
	In general (with rotation and magnetism), {\rayleigh} evolves in time a set of coupled PDEs for the 3D vector velocity $\vecu$, vector magnetic field $\vecb$, pressure perturbation $P$ (perturbation away from the ``reference" or ``background" state), and entropy perturbation $S$. Note that $S$ can also be interpreted as a temperature perturbation in Boussinesq mode. For more details, see {\rayleigh}'s \href{https://rayleigh-documentation.readthedocs.io/en/latest/doc/source/User_Guide/physics_math_overview.html#the-system-of-equations-solved-in-rayleigh}{Documentation}. 
	
	We use standard spherical coordinates $(r,\theta,\phi)$ and cylindrical coordinates $(\lambda,\phi,z) = (r\sint,\phi, r\cost)$, and $\e_q$ in general denotes a position-dependent unit vector in the direction of increasing $q$. The full PDE-set is then:
	\begin{align}
	\Div[f_1\ofr\vecu] &= 0\label{eq:contgen},\\
	\Div \vecb &= 0,
\end{align}
\begin{subequations}\label{eq:momgen}
	\begin{align}
		f_1\ofr\left[\matderiv{\vecu}+c_1\ez\times\vecu\right] =&\ c_2f_2\ofr S\er - c_3 f_1\ofr\nabla\left[ \frac{P}{f_1\ofr} \right], \nonumber\\
		& +c_4(\curl\vecb)\times\vecb+c_5\Div\bm{D},\\
		\where D_{ij} \define&\ 2f_1\ofr f_3\ofr \left[e_{ij} - \frac{1}{3}(\Div\vecu) \delta_{ij} \right]\label{eq:dstressgen}\\
		\andd e_{ij} \define&\ \frac{1}{2}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} \right),\label{eq:estressgen}
	\end{align}
\end{subequations}
\begin{align}\label{eq:engen}
	f_1\ofr f_4\ofr \matderiv{S} = &- f_1\ofr f_4\ofr f_{14}\ofr u_r + c_6\Div[f_1\ofr f_4\ofr f_5\ofr \nabla S] \nonumber \\
	&+ c_6f_{10}(r) + c_8 c_5 D_{ij}e_{ij} + \frac{\eta\ofr}{4\pi}|\curl\vecb|^2,
\end{align}
\begin{align}\label{eq:indgen}
	\andd \pderiv{\vecb}{t} = \curl(\vecu\times\vecb) - c_7\curl[f_7\ofr\curl\vecb],
\end{align}
where $D/Dt\define \partial/\partial t+\vecu\cdot\nabla$ denotes the material derivative. 
	The spherically-symmetric, time-independent reference (or background) functions $f_i(r)$ and constants $c_j$ set the fluid approximation to be made. {\rayleigh} has built-in modes to set the $f$'s and $c$'s for single-layer (i.e., either convectively stable or unstable, but not both) Boussinesq or Anelastic spherical shells. More complex systems (coupled stable--unstable systems or alternative non-dimensionalizations) require the user to manually change the $f$'s and $c$'s. This can be done by editing an input binary file that {\rayleigh} reads upon initialization. The $c$'s can also be changed in the ASCII text-file (i.e., the \texttt{main\_input} file). 
	
	\section{Dimensional Anelastic Equations}
	We begin by writing down the full dimensional anelastic fluid equations, as they are usually implemented in {\rayleigh} (\texttt{reference\_type = 2}). This form of the anelastic approximation in a spherical shell is derived in, or more accurately, attributed to (since {\rayleigh} ``updates" the background state slightly differently than the cluge-y \texttt{ASH} implementation), two common sources: \citet{Gilman1981} and \citet{Clune1999}. {\rayleigh}'s dimensional anelastic equation-set is:
	\begin{align}
		\Div[\rhoref\ofr\vecu] &= 0\label{eq:contdim},\\
		\Div \vecb &= 0,
	\end{align}
	\begin{subequations}\label{eq:momdim}
	\begin{align}
		\rhoref\ofr\left[\matderiv{\vecu}+2\Omega_0\ez\times\vecu\right] = &  \left[\frac{\rhoref\ofr \gref\ofr}{\cp}\right] S\er-\rhoref\ofr\nabla\left[ \frac{P}{\rhoref\ofr} \right], \nonumber\\
		&+ \frac{1}{\mu}(\curl\vecb)\times\vecb+\Div\bm{D},\\
		\where D_{ij} &\define 2\rhoref\ofr\nuref\ofr \left[e_{ij} - \frac{1}{3}(\Div\vecu) \delta_{ij} \right]\label{eq:dstressdim}\\
		\andd e_{ij} &\define \frac{1}{2}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} \right),\label{eq:estressdim}
	\end{align}
	\end{subequations}
	\begin{align}\label{eq:endim}
		\rhoref\ofr\tmpref\ofr \matderiv{S} = &- \rhoref\ofr\tmpref\ofr \frac{d\sref}{dr} u_r + \Div[\rhoref\ofr \tmpref\ofr \kapparef\ofr \nabla S] \nonumber \\
		&+ \qref(r) + D_{ij}e_{ij} + \frac{\etaref\ofr}{\mu}|\curl\vecb|^2,
	\end{align}
	\begin{align}\label{eq:inddim}
	\andd \pderiv{\vecb}{t} = \curl(\vecu\times\vecb) - \curl[\eta\ofr\curl\vecb].
	\end{align}
	Here, the thermal variables $\rho$, $T$, $P$, and $S$ refer to the density, temperature, pressure, and entropy (respectively). The overbars denote the spherically-symmetric, time-independent background state. The lack of an overbar on a thermal variable indicates the (assumed small) perturbation from the background (for the entropy, $S/\cp$ is assumed small).
	
	Other background quantities that appear are the gravity $\gref\ofr$, the momentum, thermal, and magnetic diffusivities [$\nuref\ofr$, $\kapparef\ofr$, and $\etaref\ofr$ , respectively], the internal heating or cooling $\qref\ofr$, the frame rotation rate $\Omega_0$, the specific heat at constant pressure $\cp$, and the vacuum permeability $\mu$ ($=4\pi$ in c.g.s. units). The equations are written in a frame rotating with angular velocity $\Omega_0$ and the centrifugal force is neglected. 
	
	Note that the internal heating and cooling function $\qref\ofr$ is a reference-state quantity (and thus assumed spherically-symmetric and time-independent) but should be interpreted as $-\Div\frad$, where $\frad$ is the radiative heat flux and properly should be proportional to the radiative diffusivity $\kappa_{\rm rad}$ (which takes on a specific form in the radiative diffusion approximation, derivable from the opacity) and to the gradient of the total temperature $\tmpref + T$. 
	
	In {\rayleigh}, a convective layer is usually driven by a combination of internal heating and the thermal boundary conditions (which are conditions on $S$), that together ensure that an imposed energy flux is transported throughout the layer in a steady state. (Note that energy could also be forced across the layer by fixing the entropy $S$ at each boundary, such that an ``adverse" (negative) radial entropy gradient is obtained in a steady state).   \textbf{In the Jupiter models, we will allow $\qref\ofr$ to also include a cooling term at the top of the convection zone. That is, we will set $\pderivline{S}{r}\equiv0$ at both the top and bottom boundary (no conduction in or out), and the flux of energy across the system will be imposed purely by the function $\qref\ofr$}. 
	
	%Note that Equation \eqref{eq:estressdim} is only valid in a Cartesian coordinate system ($x_1$, $x_2$, $x_3$) (with $i$ and $j$ running over 1, 2, 3) and is translated into spherical coordinates before being used in Rayleigh. 
	
	Finally, we recall the relation
	\begin{align}
		\dsdr = \cp \frac{\nsqref\ofr}{\gref\ofr},
	\end{align}
	where $\nsqref\ofr$ is the squared buoyancy frequency, which we will use in favor of $\dsdrline$ in subsequent equations. 
	
	Note that the original equations in \citet{Gilman1981} and \citet{Clune1999} were derived assuming a nearly-adiabatic background state (i.e., $\dsdrline\approx0$). \citet{Brown2012} and \citet{Vasil2013} have raised concerns about using various anelastic approximations in stable layers due to non-energy-conserving gravity waves. Should we be concerned?
	
	\section{Non-Dimensional Scheme}
	We now non-dimensionalize Equations \eqref{eq:contdim}--\eqref{eq:inddim}, according to the following scheme:
	\begin{subequations}\label{eq:ndscheme}
	\begin{align}
		\nabla &\rightarrow \frac{1}{H}\nabla\label{eq:ndschemenabla},\\
		t &\rightarrow \tau t,\\
		\vecu &\rightarrow \frac{H}{\tau} \vecu,\\
		S &\rightarrow \sigma S,\\
		P &\rightarrow \tilde{\rho} \frac{H^2}{\tau^2} P,\\
		\vecb &\rightarrow (\mu\tilde{\rho})^{1/2}\frac{H}{\tau} \vecb \label{eq:ndschemeb},\\ 
		\rhoref\ofr &\rightarrow \tilde{\rho} \rhoref\ofr  \label{eq:ndschemerho}, \\
		\tmpref\ofr &\rightarrow \tilde{T} \tmpref\ofr,\\
		\gref\ofr &\rightarrow \tilde{g} \gref\ofr,\\
		\nsqref\ofr &\rightarrow \widetilde{N^2} \nsqref\ofr,\\
		\nuref\ofr &\rightarrow \tilde{\nu}\nuref\ofr,\\
		\kapparef\ofr &\rightarrow \tilde{\kappa}\kapparef\ofr,\\
		 \etaref\ofr &\rightarrow \tilde{\eta}\etaref\ofr,\\ \label{eq:ndschemeeta} 
		\andd \qref\ofr &\rightarrow \frac{H^2}{\tilde{\rho}\tilde{T}\tilde{\kappa} \sigma} \qref\ofr,
	\end{align}
	\end{subequations}
	Here, $H$ is a typical length-scale, $\tau$ a typical time-scale, and $\sigma$ a typical entropy scale. On the right-hand-sides of Equation \eqref{eq:ndscheme} and in the following non-dimensionalizations, all fluid variables, coordinates, and background-state quantities are understood to be non-dimensional. The tildes refer to``typical values" of the (dimensional) reference-state functions.
	
	Below, we will assume the time-scale is either a viscous diffusion time (i.e., $\tau=H^2/\tilde{\nu}$) or a rotational time-scale [i.e., $\tau=(2\Omega_0)^{-1}$]. %To describe the reference state, we will consider three cases for a given function's ``typical value": Its value at the inner shell boundary, its value at the outer shell boundary, or its value volume-averaged over the shell. 
	
	\section{Non-Dimensional Equations; $\tau=L^2/\tilde{\nu}$}
	In this case, Equations \eqref{eq:contdim}--\eqref{eq:inddim} become 
	\begin{align}
	\Div[\rhoref\ofr\vecu] &= 0\label{eq:contndvisc},\\
	\Div \vecb &= 0,
\end{align}
\begin{subequations}\label{eq:momndvisc}
	\begin{align}
		\rhoref\ofr\left[\matderiv{\vecu}+\frac{1}{\ek}\ez\times\vecu\right] = &-\rhoref\ofr\nabla\left[ \frac{P}{\rhoref\ofr} \right] + \frac{\ra}{\pr}\rhoref\ofr\gref\ofr S\er, \nonumber\\
		&+\Div\bm{D} +(\curl\vecb)\times\vecb,\\
		\where D_{ij} &\define 2\rhoref\ofr\nuref\ofr \left[e_{ij} - \frac{1}{3}(\Div\vecu) \delta_{ij} \right]\\
		\andd e_{ij} &\define \frac{1}{2}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} \right),
	\end{align}
\end{subequations}
\begin{align}\label{eq:enndvisc}
	\rhoref\ofr\tmpref\ofr \matderiv{S} = &- \frac{\pr}{\ra}\bvisc\rhoref\ofr\tmpref\ofr \frac{\nsqref\ofr}{\gref\ofr} u_r + \frac{1}{\pr} \Div[\rhoref\ofr \tmpref\ofr \kapparef\ofr \nabla S] \nonumber \\
	&+ \frac{1}{\pr} \qref(r) + \frac{\pr\di}{\ra} D_{ij}e_{ij} + \frac{\pr\di}{\prm\ra} \etaref\ofr|\curl\vecb|^2,
\end{align}
\begin{align}\label{eq:indndvisc}
	\andd \pderiv{\vecb}{t} = \curl(\vecu\times\vecb) - \frac{1}{\prm} \curl[\etaref\ofr\curl\vecb].
\end{align}	

The non-dimensional numbers appearing are:
\begin{subequations}
\begin{align}
	\ra &\define \frac{\tilde{g} H^3}{\tilde{\nu} \tilde{\kappa}} \frac{\sigma}{\cp}\five\text{(Rayleigh number)},\\ 
	\pr &\define \frac{\tilde{\nu}}{\tilde{\kappa}}\five\text{(Prandtl number)},\\
	\prm &\define \frac{\tilde{\nu}}{\tilde{\eta}}\five\text{(magnetic Prandtl number)},\\
	\ek &\define \frac{\tilde{\nu}}{2\Omega_0H^2}\five\text{(Ekman number)},\\	
	\bvisc &\define \frac{\widetilde{N^2}H^4}{\tilde{\nu}^2}\five\text{(buoyancy number)},\\
	\andd \di &= \frac{\tilde{g}H}{\cp\tilde{T}}\five\text{(dissipation number)},
\end{align}
\end{subequations}
Note that the dissipation number is not an independent control parameter, but a function of the non-dimensional parameters characterizing the reference state (this will be seen in Section \ref{sec:ref}). 

Note the form of the non-dimensional heating-and-cooling function:
\begin{align}\label{eq:qnd}
	\qref\ofr \define \frac{H^2}{\tilde{\rho}\tilde{T}\tilde{\kappa} \sigma} \qref\dimm\ofr,
\end{align}
where the ``dim" subscript explicitly denotes the dimensional version of a quantity. In general, $\qref(r)$ is simply an arbitrary---hopefully order unity---function. If $|\qref(r)|\gg1$, the user is dilating their Rayleigh number without saying so. If $|\qref\ofr|\ll1$, the user is contracting their Rayleigh number without saying so. 
 
The function $\qref\ofr$ takes a specific form if we assume the Rayleigh number is a ``flux" Rayleigh number. In that case, we identify the entropy scale $\sigma$ via
\begin{align}
	\sigma &= \frac{H \fluxnrtilde}{\tilde{\rho}\tilde{T}\tilde{\kappa}},\\
	\where \fluxscalar_{\rm{nr}}\ofr &\define \frac{H}{r^2}\int_{r\inn}^r Q\dimm(x) x^2 dx
\end{align}
is the (dimensional) flux not carried by radiation in a statistically steady state, $\fluxnrtilde$ refers to a volume-average of $\fluxnr\ofr$ over the convection zone (CZ) of the shell, and $r\inn$ is the inner shell boundary. In general, we will ensure that $\qref\ofr$ is nonzero only in the CZ and is normalized to have a total volume integral over the CZ of zero (i.e., heating and cooling balance). Hence, $\fluxnr\ofr$ will zero outside of the CZ. 

From Equation \eqref{eq:qnd}, we thus have
\begin{align}\label{eq:qnorm}
	\qref(r) = \frac{H}{\fluxnrtilde}\qref\dimm(r).
\end{align}
The user is thus free to choose the shape of $\qref\ofr$, but not its amplitude, since it will have to be renormalized according to Equation \eqref{eq:qnorm}, to be consistent with the definition of the Rayleigh number.

The viscous buoyancy number $\bvisc$ is the ratio of the typical squared buoyancy frequency to the squared viscous diffusion time. It is essentially a ``second (stable) Rayleigh number", and will measure the stiffness of the stable layer. In other words, $\widetilde{N^2}$ will refer to the typical value of $\nsqref\ofr$ over the stable weather layer (WL) in the shell.  The buoyancy number is independent of the Rayleigh number, which measures the ultimate instability of the CZ. 

\section{Non-Dimensional Equations; $\tau=\Omega_0^{-1}$}
In the previous section, $t$ (and things with time in the dimensions) was implied to mean $(\tilde{\nu}/H^2) t_{\rm{dim}}$, where $t_{\rm{dim}}$ was the dimensional time. We now want to use a new non-dimensional time, $t_{\rm{new}}= \Omega_0t_{\rm{dim}} = t/\ek$. We can thus find the new equations easily from Equations \eqref{eq:contndvisc}--\eqref{eq:indndvisc}. Every place we see a time dimension, we recall $t=\ek t_{\rm{new}}$, so we multiply the place where the dimension appears by $\ek$ and drop the ``new" subscript (e.g., $t\rightarrow \ek\ t$, $\vecu\rightarrow\vecu/\ek$, etc.).  We thus find (after rearranging terms)
\begin{align}
	\Div[\rhoref\ofr\vecu] &= 0\label{eq:contndrot},\\
	\Div \vecb &= 0,
\end{align}
\begin{subequations}\label{eq:momndrot}
	\begin{align}
		\rhoref\ofr\left[\matderiv{\vecu} + \ez\times\vecu\right] = &-\rhoref\ofr\nabla\left[ \frac{P}{\rhoref\ofr} \right] + \ramod \rhoref\ofr\gref\ofr S\er, \nonumber\\
		&+ \ek \Div\bm{D} +(\curl\vecb)\times\vecb,\\
		\where D_{ij} &\define 2\rhoref\ofr\nuref\ofr \left[e_{ij} - \frac{1}{3}(\Div\vecu) \delta_{ij} \right]\\
		\andd e_{ij} &\define \frac{1}{2}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} \right),
	\end{align}
\end{subequations}
\begin{align}\label{eq:enndrot}
	\rhoref\ofr\tmpref\ofr \matderiv{S} = &- \frac{\brot}{\ramod} \rhoref\ofr\tmpref\ofr \frac{\nsqref\ofr}{\gref\ofr} u_r + \frac{\ek}{\pr} \Div[\rhoref\ofr \tmpref\ofr \kapparef\ofr \nabla S] \nonumber \\
	&+ \frac{\ek}{\pr} \qref(r) + \frac{\di\ek}{\ramod} D_{ij}e_{ij} + \frac{\di\ek}{\prm\ramod} \etaref\ofr|\curl\vecb|^2,
\end{align}
\begin{align}\label{eq:indndrot}
	\andd \pderiv{\vecb}{t} = \curl(\vecu\times\vecb) - \frac{\ek}{\prm} \curl[\eta\ofr\curl\vecb].
\end{align}	

The new non-dimensional numbers appearing are:
\begin{subequations}
	\begin{align}
		\ramod &\define \frac{\ek^2}{\pr}\ra =  \frac{\tilde{g} }{H\Omega_0^2} \frac{\sigma}{\cp},\\ 
		\andd \brot &\define \ek^2 \bvisc = \frac{\widetilde{N^2}} {4\Omega_0^2} \sim \frac{\tilde{g} }{H\Omega_0^2} =  \frac{1}{\text{geometric\ oblateness}}.
	\end{align}

Note that although the ``$\dsdrline$-terms" in the non-dimensionalizations have seemingly different definitions, they are the same, since:
\begin{align}
	\frac{\pr}{\ra}\bvisc = \frac{\brot}{\ramod} \sim \frac{\cp}{\sigma}.
\end{align}
\end{subequations}

\clearpage
\newpage
	\bibliography{/Users/loren/Desktop/Paper_Library/000_bibtex/library_propstyle, 
	%\bibliography{/Users/loren/Desktop/Paper_Library/000_bibtex/library, 
			/Users/loren/Desktop/Paper_Library/000_bibtex/proceedings,
			/Users/loren/Desktop/Paper_Library/000_bibtex/books}
	\bibliographystyle{aasjournal}

\end{document}