% document type and language
\documentclass[12pt]{article}

% standard packages
\usepackage{amsmath, bm, empheq, mathrsfs, natbib, cancel}
% label equations by section first, then equation in that section
\numberwithin{equation}{section}

% normal margins
\usepackage[margin=1in]{geometry}

% plane blue hyperlinks
\usepackage[colorlinks]{hyperref}
\hypersetup{
	colorlinks = true,
	linkcolor=blue,
	urlcolor=blue,
	citecolor=blue
}

% common macros
\input{../macros.tex}

% other macros
\newcommand{\nad}{n_{\rm{ad}}}
\newcommand{\dimm}{_{\rm{dim}}}
\newcommand{\cz}{_{\rm{CZ}}}
\newcommand{\wl}{_{\rm{WL}}}
\newcommand{\dcool}{\delta_{\rm{cool}}}
\newcommand{\vecf}{\bm{F}}

\newcommand{\csa}{c_{{\rm s}a}}
\newcommand{\cpa}{C_{{\rm p}a}}
\newcommand{\tmpa}{T_{\rm a}}
\newcommand{\rhoa}{\rho_{\rm a}}
\newcommand{\prsa}{P_{\rm a}}
\newcommand{\ga}{g_{\rm a}}
\newcommand{\nsqa}{N^2_{\rm a}}
\newcommand{\nua}{\nu_{\rm a}}
\newcommand{\kappaa}{\kappa_{\rm a}}
\newcommand{\etaa}{\eta_{\rm a}}
\newcommand{\fnrada}{F_{\rm{nrad,a}}}

\newcommand{\lumirrad}{L_{\rm irrad}}
\newcommand{\lumkh}{L_{\rm KH}}

\newcommand{\tauovertaunu}{\left(\frac{\tau}{\taunu}\right)}
% date, author, title
\date{\today}
\author{Loren Matilsky}
\title{Implementation of an Anelastic Stable--Unstable Layer in {\rayleigh}}

%\allowdisplaybreaks
\begin{document}
	\maketitle
	\section{Purpose}\label{sec:purpose}
	This document describes how to implement, using the {\rayleigh} code, a coupled stable--unstable system. More precisely, the system consists of an unstable convection zone (CZ) that lies adjacent to a stable radiative zone (RZ) in a spherical shell. If the CZ is on top of the RZ we describe the system as ``solar-like" or a ``tachocline," etc. If the CZ is underneath the RZ (now considered a ``weather layer") we describe the system as ``Jovian" or "Jupiter," etc. It is essentially the same problem (at least to specify) either away, making this document relevant to Nic \& COFFIES (tachocline), and to Geoff, Nic, and Matt (Jupiter). In the following sections, we describe the nondimensionalization, governing equations, and reference state, along with more substantive and possibly contentious arguments by Loren concerning the system's dynamics!
	
	\section{General Equation Set Solved by {\rayleigh}}\label{sec:eqgen}
	In general (with rotation and magnetism), {\rayleigh} time-evolves a set of coupled PDEs for the 3D vector velocity $\vecu$, vector magnetic field $\vecb$, pressure perturbation $\prsprime$ (perturbation away from the ``reference-state" pressure $\prstilde$), and entropy perturbation $\entrprime$ (perturbation away from $\entrtilde$). Note that $\entrprime$ can also be interpreted as a temperature perturbation in Boussinesq mode. For more details, see {\rayleigh}'s \href{https://rayleigh-documentation.readthedocs.io/en/latest/doc/source/User_Guide/physics_math_overview.html#the-system-of-equations-solved-in-rayleigh}{Documentation}. 
	
	We use spherical coordinates: $r$ (spherical radius), $\theta$ (colatitude), $\phi$ (azimuth angle), as well as cylindrical coordinates: $\lambda=r\sint$ (cylindrical radius, or moment arm) and $z=\cost$ (axial coordinate). In general, $\e_q$ denotes a position-dependent unit vector in the direction of increasing $q$. With this notation, the full PDE-set solved by {\rayleigh} is:
	\begin{align}
	\Div(f_1\vecu) &= 0\label{eq:contgen},\\
	\Div \vecb &= 0,
\end{align}
\begin{subequations}\label{eq:momgen}
	\begin{align}
		f_1\left(\matderiv{\vecu}+c_1\ez\times\vecu\right) =&\ c_2f_2 \entrprime\er - c_3 f_1\nabla\left(\frac{\prsprime}{f_1} \right), \nonumber\\
		& +c_4(\curl\vecb)\times\vecb+c_5\Div\bm{D},\\
		\where D_{ij} \define&\ 2f_1 f_3 \left[e_{ij} - \frac{1}{3}(\Div\vecu) \delta_{ij} \right]\label{eq:dstressgen}\\
		\andd e_{ij} \define&\ \frac{1}{2}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} \right),\label{eq:estressgen}
	\end{align}
\end{subequations}
\begin{align}\label{eq:engen}
	f_1 f_4 \left(\matderiv{\entrprime} + c_{11}f_{14} u_r\right) =&\ c_6\Div(f_1 f_4 f_5 \nabla \entrprime) \nonumber \\
	&+ c_{10}f_6 + c_8 c_5 D_{ij}e_{ij} +c_9c_7f_7|\curl\vecb|^2,
\end{align}
\begin{align}\label{eq:indgen}
	\andd \pderiv{\vecb}{t} = \curl\left[\vecu\times\vecb - c_7 f_7\curl\vecb\right],
\end{align}
where $D/Dt\define \partial/\partial t+\vecu\cdot\nabla$ denotes the material derivative. There are also functions $f_8$--$f_{13}$, which depend on radial derivatives of other functions and always take the same form no matter what is chosen for the $c$'s and $f$'s. 

The shell geometry (i.e., aspect ratio) and reference state fully define the problem. (I have always found that initial conditions seem to ultimately be irrelevant to the final state of the system, although this of course doesn't rule out hysteresis effects from occurring in future cases). The reference state is defined by the spherically-symmetric, time-independent functions $f_i=f_i(r)$ and constants $c_j$. By adjusting the $f_i$ and $c_j$, the user can choose between a Boussinesq or anelastic approximation (the specific form of each approximation is described more fully in the  \href{https://rayleigh-documentation.readthedocs.io/en/latest/doc/source/User_Guide/physics_math_overview.html#the-system-of-equations-solved-in-rayleigh}{Documentation}), choose any arbitrary nondimensionalization of these two equation sets, and/or set the nondimensional parameters (Rayleigh number, Prandtl number, etc.) of the problem.  {\rayleigh} has built-in modes to set the $f_i$ and $c_j$ for the single-layer (i.e., either convectively stable or unstable, but not both) Boussinesq approximation (nondimensional only) and anelastic approximation (either dimensional or two choices of nondimensional). These modes are chosen via the choices $\texttt{reference\_type = 1,2,3}$ or $\texttt{5}$. 

More complex systems, which {\rayleigh} also supports, require the user to manually change the $f_i$ and $c_j$. This can be done by editing an input binary file that {\rayleigh} reads upon initialization and setting $\texttt{reference\_type = 4}$ . This document essentially describes how to produce such a ``custom" input file (here called {\texttt{customfile}}) for a coupled stable--unstable anelastic system, using a variety of chosen time-scales in the nondimensionalization. I also unpack what the ``energy flux" means when stable layers are present, and the possibly contentious issue (between me and Nic) of how many new parameters define the stable layer (I think there are two!). 

Note that the $c_j$ can also be over-written at run-time by an ASCII text-file (i.e., the \texttt{main\_input} file), allowing easy changes of the nondimensional numbers for a simulation suite that uses a common reference state---all without modifying the  {\texttt{customfile}}.
	
	\section{Dimensional Anelastic Equations}\label{sec:eqdim}
	We begin by writing down the full dimensional anelastic fluid equations, as they are usually implemented in {\rayleigh} (more precisely, these equations, under the polytropic assumption, correspond to \texttt{reference\_type = 2}). This form of the anelastic approximation in a spherical shell is derived in, or more accurately, attributed to (since {\rayleigh} ``updates" the reference state slightly differently than the cluge-y \texttt{ASH} implementation), two common sources: \citet{Gilman1981} and \citet{Clune1999}. {\rayleigh}'s dimensional anelastic equation-set is:
	\begin{align}
		\Div(\rhotilde\vecu) &= 0\label{eq:contdim},\\
		\Div \vecb &= 0,
	\end{align}
	\begin{subequations}\label{eq:momdim}
	\begin{align}
		\rhotilde\left(\matderiv{\vecu}+2\Omega_0\ez\times\vecu\right) = &  \left(\frac{\rhotilde \gtilde}{\cpcap}\right) \entrprime\er-\rhotilde\nabla\left( \frac{\prsprime}{\rhotilde} \right), \nonumber\\
		&+ \frac{1}{\mu}(\curl\vecb)\times\vecb+\Div\bm{D},\\
		\where D_{ij} &\define 2\rhotilde\nutilde \left[e_{ij} - \frac{1}{3}(\Div\vecu) \delta_{ij} \right]\label{eq:dstressdim}\\
		\andd e_{ij} &\define \frac{1}{2}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} \right),\label{eq:estressdim}
	\end{align}
	\end{subequations}
	\begin{align}\label{eq:endim}
		\rhotilde\tmptilde \left(\matderiv{\entrprime} + \frac{d\entrtilde}{dr} u_r\right) = &\ \Div(\rhotilde \tmptilde \kappatilde \nabla \entrprime) +\heatra+ D_{ij}e_{ij} + \frac{\etatilde}{\mu}|\curl\vecb|^2,
	\end{align}
	\begin{align}\label{eq:inddim}
	\andd \pderiv{\vecb}{t} = \curl\left(\vecu\times\vecb - \etatilde\curl\vecb\right).
	\end{align}
	Here, the thermal variables $\rho$, $T$, $P$, and $S$ refer to the density, temperature, pressure, and entropy (respectively). The tildes denote the reference state and the primes denote the (assumed small) perturbations from the reference state. More specifically, the essence of the anelastic approximation involves assuming all relative thermal perturbations ($\rhoprime/\rhoa$, $\tmpprime/\tmpa$, $\prsprime/\prsa$, and $\entrprime/\cpcap$) are $O(\epsilon)$, where $\epsilon\ll1$ (e.g., \citealt{Ogura1962,Gough1969} and \citealt{Matilsky2024b}, coming soon!). Here, the ``a" subscripts denote ``typical reference-state values" and $\epsilon$ is also the same (small) size as the typical squared Mach number of the convection.
	
	Other background quantities that appear are the full (i.e., not ``effective") gravitational acceleration $\gtilde$, the momentum, thermal, and magnetic diffusivities ($\nutilde$, $\kappatilde$, and $\etatilde$ , respectively; these all have c.g.s. units of $\stoke$), {\rayleigh}'s internal heating $\heatra$ (much more on this below), the frame rotation rate $\Omega_0$, the specific heat at constant pressure $\cpcap$, and the vacuum permeability $\mu$ ($=4\pi$ in c.g.s. units). The equations are written in a frame rotating with angular velocity $\Omega_0\ez$ and the centrifugal force is neglected. Note that $\cpcap$ is always assumed to be constant, while in a real stellar (or gas-giant) structure model, it should technically vary in radius as the ``perfectness" of the gas varies. 
	
	\section{My Reference State: a Flimsy Approach to Stellar Structure}\label{sec:ref}
	In the anelastic equations, the one-dimensional reference state should satisfy equilibrium conditions in the momentum and energy equations. These one-dimensional equations are then subtracted from the fully compressible equations and linearized in the primed thermodynamic quantities to produce the anelastic approximation. Ideally, the reference state would be chosen based on a state-of-the-art structure model, incorporating all known physics as best we can. In the Sun, for example, this structure model is fairly well agreed-upon (e.g., \citealt{ChristensenDalsgaard1996}); but in the Jovian case, much less so (e.g., \citealt{Guillot2005}). In our (or possibly just Loren's) philosophy, the form of the reference state itself matters far less than the fact that we cannot approach realistic astrophysical conditions for stars or gas giants. Therefore, we choose the reference state somewhat arbitrarily. Put another way, we choose the $f_i$ to be slightly wrong and are consoled by the fact that the $c_j$ are \textit{incredibly} wrong. 
	
	When the reference state is fixed in time as it is in {\rayleigh}, the anelastic equations have no idea whether the one-dimensional equations subtracted out make any sense. It is up to us to be wise and enforce things like hydrostatic balance and thermal equilibrium. In the end, we end up enforcing the former, but not the latter. But either way, {\rayleigh} will happily chug along under any arbitrary reference state with no (obvious) poor consequences. 
	
	It winds up being helpful to recall exactly what structure model we are subtracting off, as well as what we \textit{should} be subtracting off. That is because there can be a lot of confusion, especially when interpreting ``flux through the system." Clarification of this energy flux is the main purpose of this and the following sections. 
	
	To specify our reference state, we demand that the gas be in hydrostatic balance,
	\begin{align}\label{eq:dimhydro}
	\frac{d\tilde{P}}{dr}= -\rhotilde \gtilde,
	\end{align}
	be perfect,
	\begin{align}
	\prstilde &= \rhotilde\gasconst \tmptilde,\label{eq:dimidgas}
	\end{align}
	and be in local thermodynamic equilibrium (LTE), 
	\begin{subequations}\label{eq:dimfirstlaw}
	\begin{align}
		\frac{1}{\cpcap}\frac{d\entrtilde}{dr}&=\frac{1}{\gamma}\frac{d\ln\tmptilde}{dr} - \frac{\gamma - 1}{\gamma}\frac{d\ln\rhotilde}{dr}\label{eq:dimfirstlawtmprho}\\
		&=\frac{1}{\gamma}\frac{d\ln\prstilde}{dr} - \frac{d\ln\rhotilde}{dr}\label{eq:dimfirstlawprsrho}\\
		&= \frac{d\ln\tmptilde}{dr} - \frac{\gamma - 1}{\gamma}\frac{d\ln\prstilde}{dr}\label{eq:dimfirstlawtmpprs}
	\end{align}
	\label{eq:firstlaw3}
\end{subequations}

Here, $\gasconst=\cpcap-\cvcap$ is the gas constant, $\cvcap$ is the specific heat at constant volume (or equivalently, constant density), and $\gamma=\cpcap/\cvcap$ is the ratio of specific heats. All are assumed to be constant (that is the definition of a perfect, not just ideal, gas). 

Really, Equation \eqref{eq:dimfirstlaw} is simply an expression of the first law of thermodynamics. It doesn't further constrain the structure problem, but rather introduces a new unknown, i.e., the entropy $\entrtilde$. The approach I employ (which is easiest, and therefore ``flimsy") is simply to choose $d\entrtilde/dr$ to enforce convective stability or not, and also pick $\gtilde\propto1/r^2$. Then the structure problem is easily solved (see Section \ref{sec:ref2}). 

\section{The Real Structure Problem}\label{sec:refreal}
In an ideal world, we would not choose an arbitrary $d\entrtilde/dr$, but instead demand a condition for thermal (in stars, ``radiative") equilibrium. This would generate another equation constraining $\rhotilde$ and $\tmptilde$ in addition to Equations \eqref{eq:dimhydro}--\eqref{eq:dimfirstlaw}, and thus fully define the structure problem. Let's explicitly consider radiative equilibrium only, since this applies in many stellar interiors in the deep parts and (maybe) in the weather layer of Jupiter. The radiative diffusion approximation in stars makes the structure problem much easier than for the (relatively cold) gas giants, since we only need to consider the opacity of a fully ionized gas (and even then, it's complicated). Under the radiative diffusion approximation (and making a mixing-length assumption), the equation of radiative equilibrium is
\begin{subequations}\label{eq:dimradequil}
\begin{align}
	\heattilde - \Div\fradtilde &= \Div\fconvtilde\label{eq:dimradequil1},\\
	\where \fradtilde &\define  -\rhotilde \cpcap\kradtilde \nabla\tmptilde=-\rhotilde \cpcap\kradtilde \frac{d\tmptilde}{dr}\er,\label{eq:dimradequil2}\\
	 \Div\fconvtilde &\define \begin{cases} 0 \five &\text{for}\five \nabla_{\rm rad} <\nabla_{\rm ad}\ \text{(stable to convection)}\\
	[\heattilde - \Div\fradtilde]_{(\rhotilde,\tmptilde)=(\rhotilde_{\rm ad}, \tmptilde_{\rm ad})}&\text{for}\five \nabla_{\rm rad} >\nabla_{\rm ad}\ \text{(unstable to convection)}\
		\end{cases},\label{eq:dimradequil3}\\
		\nabla_{\rm rad}&\define \frac{d\ln\tmptilde_{\rm rad}/dr}{d\ln\prstilde/dr} \define \frac{\gamma-1}{\gamma}\frac{\lumtilde}{4\pi r^2 \gtilde \rhotilde \kradtilde},\label{eq:dimradequil4}\\
		\andd \nabla_{\rm ad}&\define  \left(\frac{d\ln\tmptilde}{d\ln\prstilde}\right)_{\rm ad} = \frac{\gamma-1}{\gamma}.
\end{align}
\end{subequations}
Here, $\heattilde=\heattilde(\rhotilde,\tmptilde)$ is the ``real" reference-state internal heating per unit volume (likely due to nuclear burning in the core, or in Jupiter, Kelvin-Helmholtz contraction and solar irradiance), $\lumtilde\equiv 4\pi\int_0^r \heattilde(x) x^2dx$ is the total luminosity (power output) of the object interior to $r$, and $\kradtilde=\kradtilde(\rhotilde,\tmptilde)$ is the reference-state radiative diffusivity (units $\stoke$), which in turn depends on the opacity. The notation $(\rhotilde_{\rm ad}, \tmptilde_{\rm ad})$ means ``the continuation of $\rhotilde$ and $\tmptilde$ assuming adiabatic stratification."

In practice, Equations \eqref{eq:dimhydro}--\eqref{eq:dimradequil} would be solved by integrating inward from an appropriate boundary condition at the photosphere. At each point, the relative values of $\nabla_{\rm rad}$ and $\nabla_{\rm ad}$ would be compared to determine which of the two forms of Equation \eqref{eq:dimradequil3} to use. Doing so implicitly adheres to the mixing-length assumption, because it is implied that ``convection is locally determined." Wherever $\nabla_{\rm rad} <\nabla_{\rm ad}$ there is no convection at all ($\fconvtilde=0$) and wherever $\nabla_{\rm rad} >\nabla_{\rm ad}$ the convection is so vigorous that the layer is completely adiabatically stratified. No overshoot is allowed! 

\section{Energy Fluxes: What Belongs to the Reference State?}\label{sec:flux}
The reference-state $\heattilde$ and the $\heatra$ used by {\rayleigh} have physically quite different origins. Really, $\heatra$ is shorthand for $\Div\fconvtilde$. We describe explicitly how this works here. 

Subtracting Equation \eqref{eq:dimradequil} from the fully compressible heat equation (see \citealt{Matilsky2024b}) yields
\begin{subequations}\label{eq:endim2}
\begin{align}
	\rhotilde\tmptilde \left(\matderiv{\entrprime} + \frac{d\entrtilde}{dr} u_r\right) = &\ \heatprime -\Div\fradprime  +\Div\fconvtilde+ D_{ij}e_{ij} + \frac{\etatilde}{\mu}|\curl\vecb|^2,\\
	\where \fradprime \define & -\rhotilde \cpcap \kradtilde \nabla\tmpprime -\left(\frac{\rhoprime}{\rhotilde} + \frac{\kradprime}{\kradtilde}\right)\rhotilde\cpcap\kradtilde\nabla\tmptilde
\end{align}
\end{subequations}
in place of Equation \eqref{eq:endim}. 

In {\rayleigh} therefore, we have implicitly set $\heatprime\equiv0$ (i.e., we ignore the ``real" internal heating processes; so we also set $\heattilde\equiv0$) and we choose 
\begin{align}
	\heatra\define \Div\fconvtilde=-\Div\fradtilde\five\text{(since}\ \heattilde\equiv0\text{)}.
\end{align}
However, we don't pick $\fradtilde$ from a structure model, rather we set it arbitrarily, and usually proportional to $\prstilde$. In the Sun, this isn't too bad an assumption actually (see \citealt{Featherstone2016a} and the appendix of \citealt{Matilsky2024}).

We further implicitly assume
\begin{align}
\fradprime=-\rhotilde \tmptilde \kappatilde \nabla \entrprime.
\end{align}
This assumption appears to originate in \citet{Gilman1981}, which assumes a turbulent ``eddy" convective heat flux, due to unresolved motions, of the form $-\rho T\kappa\nabla S$ in the fully compressible heat equation. Making the choice to diffuse entropy, we must therefore regard $\kappa$ (and thus $\kappatilde$) as an ``eddy" diffusivity. Strictly, we really shouldn't keep having $\fradprime\propto\nabla\entrprime$ in radiative zones, where there are no ``eddies" (although maybe there are two-dimensional eddies and also secondary vertical shear instabilities that can mix things---see \citealt{Cope2020,Garaud2020}). Hopefully the baroclinic consequences of keeping $\fradprime\propto\nabla\entrprime$ in radiative zones isn't so bad!

Why all this rigamarole? It clarifies several things. First, it really only makes sense to add ``code internal heating" (like $\heatra$) to the \textit{convective} portions of the simulation. Really, $\heatra=\Div\fconvtilde$ and it only happens to look like $-\Div\fradtilde$ in our case because we exclude the ``real" internal heating $\heattilde$. Furthermore, nonzero conductive flux boundary conditions (i.e., $\pderivline{\entrprime}{r}\neq0$), which act like sources and sinks of heat in the same way as $\heatra$, should not be added to the boundaries of radiative zones. %So ideally, we would only set nonzero thermal boundary conditions ) at the boundary of a convection zone. 

Second, the Jupiter irradiance, which heats the top stable layer, really does \textit{not} constitute ``heating from above" in the same way that the interior solar radiation, which heats the bottom convection zone, constitutes ``heating from below." This is because a weather layer fully in radiative equilbrium would have $\heatra=\Div\fradtilde\equiv0$, and there is no unbalanced heating. The only place ``heating from above" comes in is in the boundary condition for $\fradtilde$, which is affected by the irradiance. This alters the reference state, but it doesn't heat or cool the fluid. Put another way, $\heatra=\Div\fconvtilde$ fundamentally refers to \textit{unbalanced} convective reference-state energy flux. When deriving the ``real" (structure-theory-based) reference state, we assumed convection played a role. When subtracting out that reference state, convection is now required to actually play that role. In any RZ, however, the reference state was already fully balanced when subtracted, so it doesn't make sense to add an unbalanced $\heatra$. 

The situation in Jupiter's weather layer could (philosophically only) be different in the sense that absorption of all wavelengths of solar radiation in the upper layers could \textit{act} like a heating from above (i.e, take the form of a volumetric heating $\heattilde$, that occupied a particular outer layer independent of the temperature gradients there), while re-emission would occur (maybe in the infra-red) by altering the temperature gradient to enforce $\Div\fradtilde=\heattilde$. But again, this balance is subtracted off the heat equation and leaves no unbalanced ``code internal heating" (i.e., $\heatra=\Div\fconvtilde$ still should $=0$).  %and is irrelevant to the anelastic approximation. The only relevant part of the energy balance of the reference state is the sign of $d\entrtilde/dr$. 

Third and finally, when we think of anelastic energy fluxes, these fluxes are only responsible for carrying out $\lumkh$, i.e., the Kelvin-Helmholtz contraction luminosity that is internal to Jupiter. There is no flux necessary to account for $\lumirrad$ (the luminosity associated with energy absorbed through irradiance), because this flux has been subtracted out and should be associated with the reference state. 

We \textit{do} need to set an outward conductive flux at the top of the weather layer (i.e., $\pderivline{\entrprime}{r}<0$) in order to maintain thermal equilibrium in the convecting state. This is indeed unfortunate, given the convective origin of entropy diffusion discussed above. Its baroclinic consequences (which now may be more relevant, given our goal to investigate ``shallow driving") have not been explored to my knowledge. Note that the top conductive flux will make the weather layer less stable than it otherwise would be. But as long as the weather layer is sufficiently stiff (i.e., has high buoyancy frequency), it should be a minimal effect. The same issue arises in the tachocline models at the base of the RZ, but there takes the form $\pderivline{\entrprime}{r}=0$, instead of a nonzero conductive flux. 

%Finally (I definitely hadn't appreciated this), if $\Div\fradtilde$ \textit{does} equal zero everywhere in the weather layer, what is the appropriate value of $|\fradtilde|$ at the top of the ? Is it $\fluxkh+\fluxirrad$
This is all to say, I am now fully converted to the idea of setting stability via $d\entrtilde/dr$, instead of using heating layers in different places. I also view \citet{Heimpel2022}, who implements a stable layer above the convective layer, as effectively using heating layers also, since they set the conductive flux to be ``into the layer" at both boundaries. This approach has the added disadvantage that the location between convectively stable and unstable cannot be set a priori. 

%I also don't think it matters much if we get $d\entrtilde/dr$ from an actual structure model or we make it up. In the Sun (where we actually know the stiffness of the radiative layer), we are a little more constrained, but in Jupiter, it seems we can say whatever we want. 





% fluid resp then I am including thermal boundary conditions that implement nonzero energy fluxes at the boundary as well. $\heatra$ shou
% After the structure problem was solved  %Note that $\heattilde$ is a reference-state quantity (and thus assumed to be spherically-symmetric and time-independent) but should be interpreted as $\heattilde=-\Div\frad$, where $\frad$ is the radiative heat flux. Properly, $\heattilde$ should be proportional to the radiative diffusivity $\kappa_{\rm rad}$ (which takes on a specific form in the radiative diffusion approximation, derivable from the opacity) and to the gradient of the total temperature $\tmptilde + T$; and $C$ should be calculated using complicated near-surface physics. 


%	In {\rayleigh}, a convective layer is usually driven by a combination of internal heating and the thermal boundary conditions (which are conditions on $\entrtilde$), that together ensure that an imposed energy flux is transported throughout the layer in a steady state. (Note that energy could also be forced across the layer by fixing the entropy $\entrtilde$ at each boundary, such that an ``adverse" (negative) radial entropy gradient is obtained in a steady state).   \textbf{In the Jupiter models, which will have both internal heating and cooling, we will set $\pderivline{S}{r}\equiv0$ at both the top and bottom boundary (no conduction in or out), and the flux of energy across the system will be imposed purely by the combination $Q-C$}. 
	
	%Note that Equation \eqref{eq:estressdim} is only valid in a Cartesian coordinate system ($x_1$, $x_2$, $x_3$) (with $i$ and $j$ running over 1, 2, 3) and is translated into spherical coordinates before being used in Rayleigh. 
	

	
	%Note that the original equations in \citet{Gilman1981} and \citet{Clune1999} were derived assuming a nearly-adiabatic background state (i.e., $\dsdrtildeline\approx0$). \citet{Brown2012} and \citet{Vasil2013} have raised concerns about using various anelastic approximations in stable layers due to non-energy-conserving gravity waves. Should we be concerned?
	
	\section{Non-Dimensional Scheme}\label{sec:ndscheme}
	In this section, $H$ denotes the typical length-scale (chosen to be the CZ thickness) and $\tau$ the typical time-scale (left general for now). 
	
	We recall the relation,
	\begin{align}\label{eq:nsq}
	\nsqtilde = \frac{\gtilde}{\cpcap}\dsdrtilde,
	\end{align}
	where $\nsqtilde$ is the squared buoyancy frequency, which we will use in favor of $\dsdrtildeline$ in most subsequent equations.
	
	We define the ``energy flux not carried by radiation" via
	\begin{align}
		\fnradtilde \define \frac{1}{r^2}\int_{\rbcz}^r\heatra(x)x^2dx,
	\end{align}
	where $\rbcz$ is the radius of the base of the CZ. We also denote the top of the CZ by $\rtcz$, the base of the RZ by $\rbrz$, and the top of the RZ by $\rtrz$. Note that $\fnradtilde$ is basically similar to $|\fconvtilde|$, however in the context of stellar structure theory, $\fconvtilde$ is computed according to a definite logic, whereas we choose our $\heatra$ arbitrarily.
	
	$\Delta S$ denotes the (\textit{estimated}) entropy difference across the CZ, and thus (hopefully, for ``normal" convection) a typical value of $\entrprime$ in the CZ. In Rayleigh-B\'enard-type convection, the true entropy difference is imposed directly. We could do this as well, by fixing $\entrprime$ itself at the inner and outer boundaries. However, instead we typically set the entropy difference indirectly by adding the internal heating $\heatra$ and balancing it with the conductive energy flux at the boundaries (which we set by fixing $\pderivline{\entrprime}{r}$ in place of $\entrprime$ itself at at least the bottom boundary). We estimate the resultant entropy difference via
	\begin{align}\label{eq:deltas}
		\Delta S \define \frac{\fnrada H}{\rhoa\tmpa\kappaa},
	\end{align}
	The ``a" subscripts again refer to``typical values" of the (dimensional) atmospheric reference-state functions. Equation \eqref{eq:deltas} essentially assumes that there is a conductive boundary layer (at the top of the CZ, since $\heatra$ must be concentrated more toward the base of the CZ in order to drive convection) that carries the full internal luminosity $L\define 4\pi \int_{\rbcz}^{\rtcz}\heatra(x)x^2dx$ out of the CZ. Note that this is a crude estimate, since the ultimate boundary layer thickness is unknown (and will be substantially less than $H$). Furthermore, we will choose CZ volume-averages for the ``typical values" of $\rhotilde$, $\fnradtilde$, etc., which will be higher than the boundary-layer appropriate values. After the fact, we can easily see how bad our assumptions are, by calculating the actual entropy difference across the CZ post-equilibration and comparing to 1. 
	
	We now nondimensionalize Equations \eqref{eq:contdim}--\eqref{eq:inddim}, according to the following scheme:
	\begin{subequations}\label{eq:ndscheme}
	\begin{align}
		\nabla &\rightarrow \frac{1}{H}\nabla,\\
		t &\rightarrow \tau t,\\
		\vecu &\rightarrow \frac{H}{\tau} \vecu,\\
		\entrprime &\rightarrow (\Delta S) \entrprime,\\
		\prsprime &\rightarrow \tilde{\rho} \frac{H^2}{\tau^2} \prsprime,\\
		\vecb &\rightarrow (\mu\tilde{\rho})^{1/2}\frac{H}{\tau} \vecb,\\ 
		\rhotilde &\rightarrow \rhoa \rhotilde, \\
		\tmptilde &\rightarrow \tmpa \tmptilde,\\
		\gtilde &\rightarrow g_a \gtilde,\\
		\nsqtilde &\rightarrow \nsqa \nsqtilde,\\
		\entrtilde &\rightarrow \cpcap \entrtilde,\\
		\nutilde &\rightarrow \nua\nutilde,\\
		\kappatilde &\rightarrow\kappaa\kappatilde,\\
		 \etatilde &\rightarrow \etaa\etatilde,\\ 
		\andd \heatra &\rightarrow \frac{\fnrada}{H} \heatra
	\end{align}
	\end{subequations}
	On the right-hand-sides of Equation \eqref{eq:ndscheme} and in all of the subsequent manuscript, all fluid variables, coordinates, and background-state quantities are understood to be nondimensional. The ```typical values" denoted by the ``a" subscripts are chosen to be volume-averages over the CZ, except for $\nsqa$, which is chosen to be the volume-average over the stably stratified RZ (really ``weather layer" in the case of Jupiter). 
	
	We define the relative thicknesses of the RZ and CZ via the ``first aspect ratio"
	\begin{align}\label{eq:alpha}
		\alpha\define \frac{\rtrz-\rbrz}{\rtcz-\rbcz}
	\end{align}
	and the aspect ratio of the CZ (the ``second aspect ratio") via 
	\begin{align}\label{eq:beta}
		\beta = \frac{\rbcz}{\rtcz}.
	\end{align}
	 Since $H$ is the thickness of the CZ, we have 
	 \begin{subequations}
	 \begin{align}
	 	\rbcz &= \frac{\beta}{1-\beta},\\
	 	\rtcz &= \frac{1}{1-\beta},
	 \end{align}
	\end{subequations}
	and 
	 \begin{subequations}
	\begin{align}
		\rbrz &=\rtrz - \alpha,\\
		\with \rtrz &= \rbcz\five\five\five\text{for the solar tachocline}
	\end{align}
\end{subequations}
	and
	 \begin{subequations}
	\begin{align}
		\rbrz &=\rtcz ,\\
		\andd \rtrz &= \rbrz + \alpha \five\five\five\text{for Jupiter.}
	\end{align}
\end{subequations}
The only difference between Jupiter and the tachocline is which of the CZ or RZ is on top. 

We leave the time-scale general for now, but ultimately assume it is a rotational time-scale when running the simulations [i.e., $\tau=(2\Omega_0)^{-1}$]. Leaving $\tau$ general allows easy translation between different nondimensionalizations, if they are needed later. %To describe the reference state, we will consider three cases for a given function's ``typical value": Its value at the inner shell boundary, its value at the outer shell boundary, or its value volume-averaged over the shell. 
	
	\section{Non-Dimensional Equations (General $\tau$)}\label{sec:eqndgentau}
	There are several time-scales relevant to the problem. Putting the nondimensional parameters in terms of the time-scales more clearly elucidates each parameter's meaning. Practically, it also makes translating between different nondimensionalizations easier. The relevant (dimensional) timescales are:
	\begin{subequations}\label{eq:timescales}
		\begin{align}
			\taunu &\define \frac{H^2}{\nua}\five\five\text{viscous diffusion time (across the CZ)},\\
			\taukappa &\define \frac{H^2}{\kappaa}\five\five\text{thermal diffusion time (across the CZ)},\\
			\taueta &\define \frac{H^2}{\etaa}\five\five\text{magnetic diffusion time (across the CZ)},\\
			\tauff &\define \sqrt{\frac{\cpcap H}{\Delta S \ga}}\five\text{``effective gravity" free-fall (convective turnover) time},\\
			\tauomega &\define \frac{1}{2\omnought}\five\five\text{rotational (Coriolis) time-scale},\\
			\taun &\define \frac{1}{N_{\rm a}}\five\five\text{buoyancy (gravity-wave) time-scale},\\
			\andd \taues &\define \frac{\nsqa}{4\omnought^2}\frac{H^2}{\kappaa}=\left(\frac{\tauomega^2}{\taun^2}\right)\taukappa\five\five\text{Eddington-sweet time}.
		\end{align}
	\end{subequations}
	
	The relevant nondimensional parameters are:
	\begin{subequations}\label{eq:nondparams}
		\begin{align}
			\ra &\define \frac{\taunu\taukappa}{\tauff^2}=\frac{\ga H^3}{\nua \kappaa} \frac{\Delta S}{\cpcap}\five\text{(Rayleigh number)},\\ 
			\pr &\define \frac{\taukappa}{\taunu}=\frac{\nua}{\kappaa}\five\text{(Prandtl number)},\\
			\prm &\define \frac{\taueta}{\taunu}=\frac{\nua}{\tilde{\eta}}\five\text{(magnetic Prandtl number)},\\
			\ek &\define \frac{\tauomega}{\taunu}=\frac{\nua}{2\Omega_0H^2}\five\text{(Ekman number)},\\	
			\bu &\define \frac{\taunu\taukappa}{\taun^2}=\frac{\nsqa H^4}{\nua\kappaa}\five\text{(buoyancy number)},\\
			\andd \di &= \frac{\ga H}{\cpcap\tilde{T}}\five\text{(dissipation number)}.
		\end{align}
	\end{subequations}
	Note that in our convention, the dissipation number is not an independent control parameter, but ends up being a function of the non-dimensional parameters characterizing the reference state (this will be seen in Section \ref{sec:ref2}). Also note that $\ra$ sets the magnitude of driving in the CZ, while $\bu$ sets the magnitude of ``decelerating power" of the RZ (one aspect of the RZ's ``stiffness"). Basically, what I call $\bu$ could also be called a ``negative Rayleigh number." 
%The buoyancy number $\bu$ is the ratio of the typical squared buoyancy frequency to the thermal and viscous diffusion times. It is essentially a ``second (stable) Rayleigh number", and measures the stiffness of the stable layer (recall $\nsqa$ refers to the typical value of $\nsqtilde$ in the WL). The buoyancy number is independent of the Rayleigh number, which estimates the ultimate instability of the CZ. 
	
	Assuming rotation is present, we also define some derivative nondimensional parameters that can be formed from the parameters in Equation \eqref{eq:nondparams}: 
	\begin{subequations}\label{eq:nondparams2}
	\begin{align}
		\ramod &\define \frac{\tauomega^2}{\tauff^2}=\frac{\ra\ek^2}{\pr}=\frac{\ga}{4\omnought^2H} \frac{\Delta S}{\cpcap}\five\text{(modified Rayleigh number)},\\ 
		\roc&\define \frac{\tauomega}{\tauff}=\ek\sqrt{\frac{\ra}{\pr}}\five\text{(convective Rossby number)},\\
		\bumod &\define \frac{\tauomega^2}{\taun^2}=\frac{\taues}{\taukappa}=\frac{\bu\ek^2}{\pr}=\frac{\nsqa}{4\omnought^2} \five\text{(modified buoyancy number)},\\ 
		\sigma &\define \sqrt{\frac{\taues}{\taunu}}=\sqrt{\bumod\pr} =\frac{N_{\rm a}}{2\omnought}\sqrt{\pr}\five\text{(``$\sigma$ parameter")}
		\end{align}
	\end{subequations}

	After applying the nondimensional scheme described by Equation \eqref{eq:ndscheme}, Equations \eqref{eq:contdim}--\eqref{eq:inddim} become 
	\begin{align}
	\Div(\rhotilde\vecu) &= 0\label{eq:contnd},\\
	\Div \vecb &= 0,
\end{align}
\begin{subequations}\label{eq:momnd}
	\begin{align}
		\rhotilde\left[\matderiv{\vecu}+\frac{1}{\ek}\tauovertaunu\ez\times\vecu\right] = &\ \frac{\ra}{\pr}\left(\frac{\tau}{\taunu}\right)^2\rhotilde\gtilde \entrprime\er         -\rhotilde\nabla\left[ \frac{P}{\rhotilde} \right], \nonumber\\
		&\ +(\curl\vecb)\times\vecb +\tauovertaunu\Div\bm{D},\\
		\where D_{ij} &\define 2\rhotilde\nutilde \left[e_{ij} - \frac{1}{3}(\Div\vecu) \delta_{ij} \right]\\
		\andd e_{ij} &\define \frac{1}{2}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} \right),
	\end{align}
\end{subequations}
\begin{align}\label{eq:ennd}
	\rhotilde\tmptilde\left( \matderiv{\entrprime} + \frac{\bu}{\ra}\frac{\nsqtilde}{\gtilde} u_r\right)  = &\ \frac{1}{\pr}\tauovertaunu[\Div(\rhotilde \tmptilde \kappatilde \nabla \entrprime) + \heatra] \nonumber \\
	& + \frac{\pr\di}{\ra}\left(\frac{\taunu}{\tau}\right)\left( D_{ij}e_{ij} + \frac{1}{\prm} \etatilde|\curl\vecb|^2\right),
\end{align}
\begin{align}\label{eq:indnd}
	\andd \pderiv{\vecb}{t} = \curl\left[\vecu\times\vecb - \frac{1}{\prm}\tauovertaunu\etatilde\curl\vecb\right].
\end{align}	

It is now clear how to reach any desired nondimensionalization. Use Equations \eqref{eq:nondparams} and \eqref{eq:nondparams2} to compute the ratio $\tau/\taunu$ in terms of the nondimensional parameters and plug into Equations \eqref{eq:contgen}--\eqref{eq:indgen}. The easiest choice (given our derivation) is $\tau=\taunu$.

Note that only the \textit{ratio} of the two ``Rayleigh numbers" $\bu/\ra$ appears in the heat equation when there is a stable layer. Also note that $\bu/\ra=\tauff^2/\taun^2$---i.e., it is the (squared) ratio of the free-fall (or estimated convective turnover) time-scale to the gravity-wave time-scale.  

\section{Nondimensional equations, functions, and constants for $\tau=\tauomega$}\label{sec:eqndrot}
We now reach the end of the main part of the document, where we write down the nondimensional equations to be used, and how to input these equations into {\rayleigh} by setting the $f_i$ and $c_j$. 

For $\tau=\tauomega$, we have $\tau/\taunu=\ek=\roc\sqrt{\pr/\ra}$. Equations \eqref{eq:contnd}--\eqref{eq:indnd}, after simplification, become
\begin{align}
	\Div(\rhotilde\vecu) &= 0\label{eq:contndrot},\\
	\Div \vecb &= 0,
\end{align}
\begin{subequations}\label{eq:momndrot}
	\begin{align}
		\rhotilde\left(\matderiv{\vecu} + \ez\times\vecu\right) = &\ \rocsq \rhotilde\gtilde S\er         -\rhotilde\nabla\left[ \frac{P}{\rhotilde} \right], \nonumber\\
		&+(\curl\vecb)\times\vecb + \sqrt{\frac{\pr}{\ra}}\roc \Div\bm{D},\\
		\where D_{ij} &\define 2\rhotilde\nutilde \left[e_{ij} - \frac{1}{3}(\Div\vecu) \delta_{ij} \right]\\
		\andd e_{ij} &\define \frac{1}{2}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} \right),
	\end{align}
\end{subequations}
\begin{align}\label{eq:enndrot}
	\rhotilde\tmptilde\left( \matderiv{\entrprime}+ \frac{\sigma^2}{\rocsq\pr} \frac{\nsqtilde}{\gtilde} u_r\right)  = &\ \sqrt{\frac{1}{\pr\ra}}\roc [\Div(\rhotilde \tmptilde \kappatilde \nabla \entrtilde) + \heatra] \nonumber \\
	&+ \sqrt{\frac{\pr}{\ra}}\left(\frac{\di}{\roc}\right) \left( D_{ij}e_{ij} + \frac{1}{\prm} \etatilde|\curl\vecb|^2\right),
\end{align}
\begin{align}\label{eq:indndrot}
	\andd \pderiv{\vecb}{t} = \curl\left(\vecu\times\vecb - \sqrt{\frac{\pr}{\prm^2\ra}}\roc \etatilde\curl\vecb\right),
\end{align}	

In terms of {\rayleigh}'s $f$'s and $c$'s, we compare Equations \eqref{eq:contndrot}--\eqref{eq:indndrot} to \eqref{eq:contgen}--\eqref{eq:indgen} and find:
\begin{align*}
	\begin{split}
	f_1&\rightarrow \rhotilde\\
	f_2&\rightarrow\rhotilde\gtilde \\
	f_3 &\rightarrow \nutilde\\
	f_4 &\rightarrow \tmptilde\\
	f_5 &\rightarrow \kappatilde\\
	f_6 &\rightarrow \heatra\\
	f_7 &\rightarrow \etatilde\\
	\vdots\\
	f_{14} &\rightarrow \frac{\nsqtilde}{\gtilde}
\end{split}
\begin{split}
c_1 &\rightarrow 1\\
c_2 &\rightarrow \rocsq\\
c_3 &\rightarrow 1\\
c_4 &\rightarrow 1\\
c_5 &\rightarrow \roc\sqrt{\pr/\ra}\\
c_6 &\rightarrow \roc/\sqrt{\pr\ra}\\
c_7 &\rightarrow \roc\sqrt{\pr/(\prm^2\ra)}\\
c_8 &\rightarrow \di/\rocsq\\
c_9 &\rightarrow \di/\rocsq\\
c_{10} &\rightarrow \roc/\sqrt{\pr\ra}\\
c_{11} &\rightarrow \sigma^2/(\pr\rocsq)
\end{split}
\end{align*}
The functions $f_7$--$f_{13}$ are derivatives of other functions and we don't need to worry about them here. 

Thus, to fully set the \textit{dynamical regime} of our (rotating) simulation, we choose the following five independent nondimensional parameters: $\ra$, $\pr$, $\prm$, $\roc$, and $\sigma$. 

As an example, \citealt{Matilsky2024} Case 4.00 had:
\begin{subequations}
	\begin{align}
		\ra=\sn{5.62}{5},\\
		\pr=1,\\
		\prm=4,\\
		\roc=0.400,\\
	\andd	\sigma=79.6.
	\end{align}
\end{subequations}
A main goal of Loren and Nic's work this year is to bring $\sigma < 1$. 

For the current \citealt{Wulff2022}-inspired models we have
\begin{subequations}
	\begin{align}
		\ra\in\{10^7,\sn{3.2}{7}\},\\
		\pr = 1/2,\\
		\andd \roc \in \{0.2, 0.4\}\\
	\end{align}
\end{subequations}
This region of parameter space is inspired by the CZ-only case that appeared to have jets (see Wulff's Figure 3d. I believe this simulation had the bolded parameters in Wulff's Table 1 and 2, although it is not entirely clear from the manuscript. Anyway, we seem to have similar-looking jets!

\section{The Reference State (for Real, This Time)}\label{sec:ref2}
Here we solve the ``flimsy" stellar structure problem laid out in Section \ref{sec:ref}. We consider a spherical shell of gas (adjacent CZ and RZ) extending between inner radius $r\inn$ and outer radius $r\out$. For the Sun, $(r\inn,r\out)=(\rbrz,\rtcz)$, while for Jupiter, $(r\inn,r\out)=(\rbcz,\rtrz)$. We model the stability transition using a quartic matching function at the CZ--RZ interface for the arbitrarily chosen $\dsdrtildeline$. More specifically, the assumed transition in convective stability occurs near an intermediate radius $r_0$, over a width $\delta$. We thus define the function:
\begin{equation}
  \psi(r;r_0, \delta)\define \begin{cases}
		0 & r\leq r_0 \\
		1 - \left[1 - \Big{(}\frac{r-r_0}{\delta}\Big{)}^2\right]^2 & r_0  < r < r_0+ \delta\\
		1 & r\geq r_0+\delta.
	\end{cases}
	\label{eq:psi}
\end{equation}

We then choose 
\begin{align}\label{eq:dsdr}
	\dsdrtilde\define \begin{cases}
		\Sigma\psi(r,r_0,\delta)\five\five\five\with r_0=\rtcz&\text{for Jupiter},\\
		\Sigma[1-\psi(r,r_0-\delta,\delta)]\five\with r_0=\rbcz &\text{for the tachocline},
	\end{cases}
\end{align}
where $\Sigma$ is the nondimensional amplitude of $\dsdrtildeline$ in the RZ. Contrary to what one might expect, $\Sigma$ is actually independent of $\sigma$. The uppercase $\Sigma$ affects the radial structure of the reference state, while $\sigma$ affects the dynamics of the fluid. Each of these is a (different) aspect of the ``stiffness" of the RZ. More on this (since Nic will probably need convincing) below. 

With this formulation, the CZ is \textit{strictly} unstable (really, marginally stable, but becomes unstable because of the heating). This ensures that none of the stable gradient ``leaks" into the CZ, as happens with (e.g.) tanh matching (see \citealt{Matilsky2024}). 

We also define the nondimensional entropy itself via
\begin{align}
	\entrtilde = \int_{r_0}^r \frac{d\entrtilde}{dx}dx,
\end{align}
where (without loss of generality, since only differences in $\entrtilde$ matter in the end) we have chosen the zero-point of $\entrtilde$ to be at $r_0$, or equivalently (since $\dsdrtildeline\equiv0$ in all of the CZ), the zero-point of the entropy is anywhere in the CZ.  

We assume a centrally-concentrated mass so that $\gtilde\propto 1/r^2$. With the requirement that the volume-average of $\gtilde$ over the CZ be unity, we find
\begin{align}
	\gtilde &= \left[ \frac{1-\beta^3}{3(1-\beta)^3}    \right]\frac{1}{r^2}.
\end{align}

Under the scaling of Equation \eqref{eq:ndscheme}, Equations \eqref{eq:dimhydro}, \eqref{eq:dimidgas}, and \eqref{eq:dimfirstlaw} become (respectively)
\begin{align}\label{eq:hydro}
	\frac{d\tilde{P}}{dr}= -\di\left(\frac{\gamma}{\gamma-1}\right)\rhotilde \gtilde,
\end{align}
\begin{align}
	\prstilde &= \rhotilde \tmptilde,\label{eq:idgas}
\end{align}
and
\begin{subequations}\label{eq:firstlaw}
	\begin{align}
		\frac{d\entrtilde}{dr}&=\frac{1}{\gamma}\frac{d\ln\tmptilde}{dr} - \frac{\gamma - 1}{\gamma}\frac{d\ln\rhotilde}{dr}\label{eq:firstlawtmprho}\\
		&=\frac{1}{\gamma}\frac{d\ln\prstilde}{dr} - \frac{d\ln\rhotilde}{dr}\label{eq:firstlawprsrho}\\
		&= \frac{d\ln\tmptilde}{dr} - \frac{\gamma - 1}{\gamma}\frac{d\ln\prstilde}{dr}\label{eq:firstlawtmpprs}
	\end{align}
\end{subequations}
We can then find an ODE for the temperature alone:
\begin{align}
	\frac{d\tmptilde}{dr}-\left(\dsdrtilde\right)\tmptilde = - \di \gtilde
\end{align}

This is integrated to find (e.g., \citealt{Matilsky2024})
\begin{align}\label{eq:tmptilde}
	\tmptilde &= e^{\entrtilde}\left[\tmptilde(\rbcz) - \di\int_{\rbcz}^r \gtilde(x)  e^{-\entrtilde(x)}dx\right].
\end{align}
and
\begin{align}\label{eq:rhotilde}
	\rhotilde &= \rhotilde(\rbcz) \exp{\left[-\left(\frac{\gamma}{\gamma-1}\right)\entrtilde\right]}\tmptilde^{1/(\gamma-1)},
\end{align}
leaving the structure problem nearly solved. 

Various derivatives of the thermal variables can also be computed:
\begin{align}
	\dlntmptilde &= \dsdrtilde - \di \frac{\gtilde}{\tmptilde},\\
	\dlnrhotilde &= -\left(\dsdrtilde + \frac{\di}{\gamma-1}\frac{\gtilde}{\tmptilde}\right),\\
	\andd \hrhotilde &=\frac{1}{\dsdrtilde + \frac{\di}{\gamma-1}\frac{\gtilde}{\tmptilde}},
\end{align}
where $\hrho\define-(\dlnrhotildeline)^{-1}$ is the local density scale-height. (We can now start to see why the amplitude $\Sigma$ is unrelated to $\sigma$ and why it is also important; it partially sets the local scale-heights in the RZ). 

To fully specify the reference-state, we need the constants $\di$, $\tmptilde(\rbcz)$, and $\rhotilde(\rbcz)$. We define the number of density scale-heights across the CZ by 
\begin{align}\label{eq:nrho}
	N_\rho &\define \ln\left[\frac{\rhotilde(\rbcz)}{\rhotilde(\rtcz)}\right].
\end{align}

Using Equation \eqref{eq:nrho}, the fact that $\entrtilde\equiv0$ in the CZ, and the requirement that $\tmptilde$ integrates to unity over the CZ, Equations \eqref{eq:rhotilde} and \eqref{eq:tmptilde} yield
\begin{align}\label{eq:digory}
	\di \define \frac{\ga H}{\cpcap\tmpa} &=  \frac{3 \beta (1 - \beta)^2 (1 - e^{-\nrho/n})} 
	{ (3\beta/2) (1 - \beta^2) (1 - e^{-\nrho/n}) - (1-\beta^3)(\beta-e^{-\nrho/n})}\\
	\andd \tmptilde(\rbcz)&= \frac{(1-\beta^3)(1-\beta)}{(3\beta/2)(1-\beta^2)(1-e^{-\nrho/n}) - (1-\beta^3)(\beta - e^{-\nrho/n})},\\
	\where n &\define \frac{1}{1-\gamma}
\end{align}
is the ``polytropic index" of the CZ. Since $\dsdrtildeline\equiv0$ in the CZ, the stratification of the CZ winds up being an adiabatic polytrope; the full CZ--RZ system, however, is \textit{not} a polytrope, nor is it equivalent to matching multiple polytropes.

Basically, we have chosen to treat $\nrho$ as an independent parameter instead of $\di$. 

The final constant $\rhotilde(\rbcz)$ ends up not having an analytical expression but can be found numerically by integration over the CZ of Equation \eqref{eq:rhotilde} and the requirement that $\rhotilde$ averages to unity over the CZ.

The diffusivity profiles $\nutilde$, $\kappatilde$, and $\etatilde$ are arbitrary and do not affect the rest of the structure model. They must have unity volume average over the CZ, however. 

The heating profile $\heatra$ is also arbitrary but must have a particular normalization. This normalization is set by our choice for $\Delta S$ and the definition of $\fnradtilde$. Following the solar case, where $|\fconvtilde|$ is roughly proportional to $\prstilde$, we choose
\begin{align}
	\heatra = \begin{cases}
		c\rhotilde\tmptilde &\text{inside the CZ}\\
		0 & \text{outside the CZ}
	\end{cases}
\end{align}
Normalization then requires
\begin{align}
	\frac{1}{c} \define \frac{3(1-\beta)^3}{1-\beta^3}\int_{\rbcz}^{\rtcz}\int_{\rbcz}^r \rhotilde(x)\tmptilde(x) x^2 dx dr. 
\end{align}
This is a discontinuous profile for $\heatra$ in the tachocline case, since $\heatra$ achieves its maximum value at $r=\rbcz$ and then drops zero below. This is tweaked slightly from the cases of \citet{Matilsky2024}, which had a smoothed $\heatra$. My suspicion from running some other models is that {\rayleigh} can handle a discontinuous $\heatra$ and that it should make a big difference to the simulation. 

\subsection{The Relationship between $\Sigma$ and $\sigma$}
What is the nondimensional parameter $\Sigma$ appearing in Equation \eqref{eq:dsdr}? Recall our choice in Equation \eqref{eq:ndscheme} to scale the dimensional background entropy with $\cpcap$ instead of $\Delta S$. Thus, $\Sigma$ really measures the magnitude of the dimensional background entropy gradient relative to $\cpcap/H$. We therefore write
\begin{align}
	\Sigma \approx \frac{H}{\cpcap} \left(\frac{d\entrtilde}{dr}\right)_{\rm a},
\end{align}
with the ``$\approx$" here meaning ``to within a knowable constant of order unity." Similarly, from Equation \eqref{eq:nsq}, we write
\begin{align}
	\nsqa \approx \frac{\ga}{\cpcap}\left(\dsdrtilde\right)_{\rm a}
\end{align} 
We thus find
\begin{subequations}
\begin{align}
	\sigma^2\approx \pr \frac{\ga}{4H\omnought^2}\Sigma\approx \frac{\pr}{f}\Sigma\label{eq:estf},\\
	\where f\define \frac{R_{\rm eq} - R_{\rm pol}}{R_{\rm eq}}
\end{align}
\end{subequations}
is the geometric oblateness of the object ($R_{\rm eq}$ and $R_{\rm pol}$ refer to the equatorial and polar radius of the object, respectively, and the estimate \eqref{eq:estf} comes from considering the relative magnitudes of centrifugal and gravitational forces). We can also estimate
\begin{align}
	\frac{1}{f} \approx \frac{\ga}{4H\omnought^2}\approx \frac{\cpcap}{\Delta S}\rocsq
\end{align}
and thus
\begin{align}
	\Sigma \approx \frac{\Delta S}{\cpcap} \frac{1}{\pr}\frac{\sigma^2}{\rocsq} = \frac{\Delta S}{\cpcap} \frac{\bumod}{\ramod} = \frac{\Delta S}{\cpcap} \frac{\bu}{\ra} = \frac{\Delta S}{\cpcap} \frac{\tauff^2}{\taun^2}. 
\end{align}
Thus, however we manipulate the expressions, $\Sigma$ cannot be reduced to a function of $\sigma$. That is because the relative entropy fluctuation $\Delta S/\cpcap$ is ordinarily not set a priori. Furthermore, without a stable layer present, only the combination $\rocsq=[\gtilde/(4H\omnought^2)](\Delta S/\cpcap)$ (or equivalent) is relevant, and only this may be set. In dimensional calculations, one can choose $\Delta S$ and $\cpcap$ separately (and thus pick a definite $\Delta S/\cpcap$), but this doesn't matter since still only the resultant $\rocsq$ is of significance. Basically, we have learned that with a stable layer present, we implicitly \textit{must} choose a value for $\Delta S/\cpcap$---really, a value for $\cpcap$, which in the CZ-only context is irrelevant---and we do this by picking $\Sigma$.

If we believe $\Delta S/\cpcap$ sets the typical entropy fluctuations in the CZ (and presumably the overshoot layer), then it must be chosen to be consistent with the anelastic approximation. This \textit{might} place an upper bound on $\Sigma$. Physically, this \textit{might} make sense: if $\Sigma$ is too high, the entropy gradient will be too high (relative to $\cpcap/H$) and overshooting plumes will develop $O(1)$ entropy fluctuations, at odds with the anelastic approximation. 

On the other hand, $\Sigma$ does \textit{not} appear anywhere in the equation-set, and can only affect the dynamics through altering the reference-state profiles $\rhotilde$ and $\tmptilde$ in the RZ. Specifically, a high $\Sigma$ means rapid radial variation in the reference-state thermal profiles and small scale-heights. It is presently unclear how small scale-heights in the RZ will affect the dynamics of overshoot (see \citealt{Matilsky2024b}). Thus, after much hemming and hawing, I would argue there is a priori \textit{no} upper bound to $\Sigma$! 

In the Sun, we know accurate values of both $\Sigma\sim1$ and $\sigma\sim0.1$ from (dimensional) solar structure models. In Jupiter, we know very little. Even the value of $\sigma$ seems uncertain---we think $\nsqa/4\omnought^2\approx 20$? What is a molecular $\pr$? I'm not sure if we could estimate $\Sigma$, which depends on reference-state \textit{gradients}, not just reference-state values. 

 \section{All the Reference-State Parameters}
 My flimsy structure model for a CZ--RZ is fully specified by six parameters, then: $\alpha$, $\beta$, $\gamma$ (or $n$), $\delta$, $\nrho$, and $\Sigma$. Other technically free ``parameters" are the radial shapes of $\nutilde$, $\kappatilde$, $\etatilde$, and $\heatra$. For Case 4.00 in \citealt{Matilsky2024}, I chose (assuming my tweak to an ``abrupt" $\heatra$ doesn't affect things)
 \begin{subequations}
 \begin{align}
 	\alpha=1,\\
 	\beta=0.759,\\
 	\gamma =5/3\ (n=3/2),\\
 	\delta = 0.219,\\
 	\nrho = 3,\\
 	\andd\Sigma = 0.453.
 \end{align}
\end{subequations}
I also chose $\heatra\propto \rhotilde\tmptilde$, and $\nutilde=\kappatilde=\etatilde\propto\rhotilde^{-1/2}$. This is the simulation I am working on extending the parameter space of (in particular, to $\sigma<1$). 

For Jupiter, I plan to extend the Wulff simulations to include a top (thin) weather layer. The CZ-only cases currently have 
 \begin{subequations}
	\begin{align}
		\beta=0.8,\\
		\gamma =3/2\ (n=2),\\
		\andd \nrho = 1.2.
	\end{align}
\end{subequations}
I also have $\heatra\propto \rhotilde\tmptilde$ and $\nutilde=\kappatilde=1$ (constant diffusivities). For the weather layer models, I plan to choose $\alpha=0.25$, $\delta=0.05$, and $\Sigma=1$. If there are any major concerns with these choices, please speak now! 

\section{Initial Boundary Conditions}
For the hydro Jupiter simulations I will initialize with small thermal perturbations (randomly distributed everywhere) of magnitude $10^{-3}$. For the MHD tachocline simulations, I will also initialize a weak seed field (randomly distributed everywhere) of magnitude $10^{-3}$. Note that this is tweaked slightly from the original Case 4.00, which had seed field only in the CZ and of amplitude $10^{-6}$. 

At both top and bottom for both Jupiter and Sun: Boundary conditions on $\vecu$ are stress-free and impenetrable, boundary conditions on $\vecb$ consist of potential-field matching. 

At bottom for both Jupiter and Sun: $\pderivline{\entrprime}{r}\equiv0$. 

At top: for Jupiter, $\entrprime\equiv0$ and for Sun, $\pderivline{\entrprime}{r}\equiv0$ (this is to follow the separate choices of \citealt{Wulff2022} and \citealt{Matilsky2024}). 

\clearpage
\newpage
%\bibliography{/Users/loren/Desktop/Paper_Library/000_bibtex/library_propstyle, 
	\bibliography{/Users/loren/Desktop/Paper_Library/000_bibtex/library, 
			/Users/loren/Desktop/Paper_Library/000_bibtex/proceedings,
			/Users/loren/Desktop/Paper_Library/000_bibtex/books}
	\bibliographystyle{aasjournal}

\end{document}