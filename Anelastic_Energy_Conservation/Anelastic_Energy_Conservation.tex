\documentclass[12pt]{article}

% standard packages
\usepackage{amsmath, amssymb,bm, empheq, mathrsfs, natbib, cancel}

% normal margins
\usepackage[margin=1in]{geometry}

% plane blue hyperlinks
\usepackage[colorlinks]{hyperref}
\hypersetup{
	colorlinks = true,
	linkcolor=blue,
	citecolor=blue
}

% common macros
\input{../macros.tex}

% other macros
\newcommand{\vecrot}{\bm{\Omega}}
\newcommand{\vecr}{\bm{r}}
\newcommand{\xpar}{x_\parallel}
\newcommand{\epar}{\e_\parallel}
\newcommand{\upar}{u_\parallel}
\newcommand{\uperp}{\vecu_\perp}
\newcommand{\vecf}{\bm{F}}
\newcommand{\veck}{\hat{\bm{k}}}

% total energies and energy densities
\newcommand{\etot}{E_{\rm tot}}

\newcommand{\wtot}{W_{\rm tot}}
\newcommand{\wke}{W_{\rm KE}}
\newcommand{\wint}{W_{\rm int}}
\newcommand{\wpot}{W_{\rm pot}}

\newcommand{\wptot}{W^\prime_{\rm tot}}
\newcommand{\wpke}{W^\prime_{\rm KE}}
\newcommand{\wpheat}{W^\prime_{\rm heat}}
\newcommand{\wpcomp}{W^\prime_{\rm comp}}
\newcommand{\wppot}{W^\prime_{\rm pot}}
\newcommand{\wpelast}{W^\prime_{\rm elast}}

% date, author, title
\date{\today}
\author{Loren Matilsky}
\title{An energy-conserving anelastic approximation for strongly stably-stratified fluids}
\begin{document}
	\maketitle
	\section{Introduction}
	Abstract: When acoustic oscillations are believed to be irrelevant to the dynamics of a fluid, it is useful to employ simplifying approximations to the equations of motion. The two most common of these (which are usually used to treat convection problems) are the Boussinesq approximation (when the background density does not significantly vary across the fluid layer) and the anelastic approximation (when the background density does vary significantly). There are many distinct forms of the anelastic approximation in the literature, and it has often been remarked that they do not properly conserve energy when the fluid is stable to convection. Here we show that the anelastic equations derived by Gough (1969) in fact do conserve energy for arbitrary motions of the fluid, even for strongly stratified background stratification. The key properties of these equations that allow them to conserve energy are (1) the absence of the Lantz-Braginsky-Roberts (LBR) approximation in the momentum equation and (2) the inclusion of a historically neglected term in the internal energy equation. These two properties allow the proper conversion between kinetic and internal energy at the correct order of the formal asymptotic expansion of the equations. We show that the scaling analysis of Gough (1969), which implicitly assumed a single typical value of the background entropy gradient, can be valid even for convective overshoot, where the entropy gradient changes from slightly unstable in the convecting region to stable (sometimes strongly so) in the overshoot region. The requirement for the anelastic equations to be valid for convective overshoot is that the buoyancy frequency be significantly less than the acoustic cutoff frequency. 
	\\
	%(i.e., $\Div(\rhoover\vecu)\equiv0$, where $\rhoover$ is the background density and $\vecu$ the fluid velocity; this takes the place of the $\Div\vecu=0$ condition from the Boussinesq approximation)
	
	The anelastic equations consist of an approximation to the continuity and momentum equations, originally derived by assuming small thermal perturbations about a nearly adiabatically stratified hydrostatic reference atmosphere \citep{Batchelor1953,Charney1960}. The thermodynamics of the problem thus become ``linear," in the sense that products of thermodynamic variables reduce to linear expressions in the first-order perturbations. The two key consequences of linearized thermodynamics are divergenceless mass flux and the first-order buoyancy force (associated with the first-order perturbed density and pressure) being the primary driver of the flow. \citet{Ogura1962} formalized the approximation by expanding the fluid equations in a small parameter $\epsilon$, representing the relative variation of potential temperature across the fluid layer, and hence the relative magnitude of the thermal perturbations. They recovered the equations of \citet{Batchelor1953} and \citet{Charney1960} and showed an assumption about the \textit{time scale} of the motion was necessary, in addition to the assumption of small thermal perturbations. Namely, the dynamical time scale of the buoyantly driven flows must be $O(\epsilon^{-1/2})$ times \textit{larger} than the sound crossing time of the region. Sound waves, which imply rapid temporal variations on the order of the sound crossing time, are thus absent from the anelastic equations, making them ideal for numerical integration, where large time steps are required to capture significant evolution of the system. 
	
	In the original asymptotic expansion of \citet{Ogura1962}, the internal energy equation was replaced by a heat (or entropy) equation for the evolution of potential temperature, \textit{before} non-dimensionalizing the equations. The approach of considering the entropy equation instead of the energy equation before nondimensionalization is repeated in all modern implementations of the anelastic approximation that we are aware of (e.g., \citealt{Gilman1981,Lipps1982,Glatzmaier1984,Lantz1992,Braginsky1995,Lantz1999,Clune1999,Rogers2005,Brown2012,Vasil2013,Wilczyski2022}). The resulting energy equation is also used in all numerical codes we are aware of that utilize the anelastic equations, for example, the {\ash} code \citep{Brun2004}, the \texttt{MagIC} code \citep{Gastine2012}, the {\rayleigh} code \citep{Featherstone2016a,Featherstone2023}, the {\eulag} code \citep{Smolarkiewicz2004}, and the \texttt{Dedalus} code \citep{Burns2020,Brown2020}. 
	
	While nondimensionalizing the entropy equation instead of the internal energy equation may at first appear to be an arbitrary (and harmless) choice, we show in the present work that it leads to an asymptotically inconsistent set of equations that do not conserve energy when the background is stably stratified. \citet{Gough1969}, by contrast, took a different approach than \citet{Ogura1962} and performed a formal asymptotic expansion in $\epsilon$ after nondimensionalizing the internal energy equation. We show that this equation set, which we dub the ``Energy-conserving Generalized Gough" (AnEGG) anelastic equations, conserve energy for arbitrary fluid motions and for all hydrostatic background states (whether stably or unstably stratified).
	
	\section{The fully compressible fluid equations}
	We begin by writing down the unapproximated fully compressible equations of motion for a nonrotating nonmagnetic fluid considered by \citet{Gough1969} (see Equations (2.1)--(2.5) from that paper). These are the continuity equation 
	\begin{align}\label{eq:cont}
		\pderiv{\rho}{t}=-\Div(\rho\vecu) 
	\end{align}
	the momentum equation,
	\begin{subequations}\label{eq:mom}
	\begin{align}
		\pderiv{}{t}(\rho\vecu)&=-\Div(\rho\vecu\vecu) - \nabla P +\rho\vecg +\Div \overleftrightarrow{D},\label{eq:mommain}\\
		\where D_{ij}& = \mu\left[\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} - \frac{2}{3}(\Div\vecu)\delta_{ij}\right],\label{eq:momvisc}
	\end{align}
	\end{subequations}
	the internal energy equation,
	\begin{align}\label{eq:en}
		\pderiv{}{t}(\rho U) + \Div(\rho U\vecu) + P\Div\vecu = D_{ij}\pderiv{u_i}{x_j} + Q - \Div\vecf,
	\end{align}
	and a general equation of state,
	\begin{align}\label{eq:eos}
		U = U(P,T).
	\end{align}
	Here, $t$ is the time, the $x_i$ are Cartesian spatial coordinates, $\rho$ is the density, $P$ the pressure, $T$ the temperature, $U$ the internal energy per unit mass, $\mu$ the dynamic viscosity, $\vecg\define -\nabla\Phi$ the graviational acceleration field, $\Phi$ the gravitational potential, $Q$ an internal heat source, and $\vecf$ the combined conductive and radiative heat flux. The gravity $\vecg$ is assumed to point in the vertical direction $\veck$ (either the upward Cartesian direction for a plane-parallel fluid layer or the radial direction for spherical shell). Additionally, $\vecg$ is assumed to depend only on the vertical coordinate $q$ (either the upward Cartesian coordinate $x_3$ or the radial coordinate $r$) and to be time-independent (i.e., self-gravity is ignored). The symbol ``$\leftrightarrow$'' in the viscous stress tensor $\overleftrightarrow{D}$ denotes a second-order tensor, as does the dyadic notation $\vecu\vecu$. The subscripts $i$ and $j$ (taking on the values 1, 2, and 3) denote vector or tensor components in any of the Cartesian coordinate directions.  We use the Einstein summation convention and $\delta_{ij}$ denotes the Kronecker delta. These equations are not written in the exact form of \citet{Gough1969} and use slightly different notation but are mathematically equivalent. 
	
	An equation for the evolution of kinetic energy can be formed from $\vecu$ dotted into Equation \eqref{eq:mom},
	\begin{align}\label{eq:ke}
		\pderiv{}{t}\left(\frac{1}{2}\rho u^2\right) = - \Div\left(\frac{1}{2}\rho u^2\vecu \right) + \ugrad P - \rho\ugrad\Phi+ u_i\pderiv{D_{ij}}{x_j}.
	\end{align}
	Equation \eqref{eq:cont} multiplied by $\Phi$ yields an equation for the evolution of potential energy,
	\begin{align}\label{eq:pote}
		\pderiv{}{t}(\rho\Phi) &= - \Phi \Div(\rho\vecu).
	\end{align}
	Adding Equations \eqref{eq:en}, \eqref{eq:ke}, and \eqref{eq:pote} yields an equation for the evolution of total energy,
	\begin{align}\label{eq:tote}
		\pderiv{}{t}\left[\rho\left(\frac{1}{2} u^2 + U + \Phi\right)\right] = -\Div\left\{\left[\rho\left(\frac{1}{2} u^2 + U + \Phi\right) + P\right]\vecu- \vecu\cdot\overleftrightarrow{D} + \vecf\right\} + Q.
	\end{align}
	Integrating Equation \eqref{eq:tote} over the volume $V$ of the fluid layer, using the divergence theorem, and assuming that the sum of the surface-integrated fluxes balances the volume-integrated heating yields\footnote{Throughout this work, we use the symbol ``$\define$" for definitions (i.e., for ``is defined to be equal to") and ``$\equiv$" for homogeneous equivalence (i.e., for ``is equal to [some constant value] everywhere and for all time").}
	\begin{subequations}\label{eq:econst}
	\begin{align}
		\etot &\define \int_V \wtot dV \equiv \text{constant},\\
		\where \wtot &\define \wke + \wint + \wpot,\\
		\wke &\define \frac{1}{2}\rho u^2,\\
		\wint &\define \rho U,\\
		\andd \wpot &\define \rho \Phi. 
	\end{align}
	\end{subequations}
	Equation \eqref{eq:econst} expresses the conservation of total energy that is implicit to the fully compressible fluid equations \eqref{eq:cont}--\eqref{eq:eos}. The volume-integrated total energy is conserved, as long as the total surface fluxes balance the total internal heat sources. Locally, by contrast, fluid parcels can exchange total energy with one another, and the sources of these exchanges are further partitioned into kinetic, internal, and potential energy. 
	
	One of the main goals of this work is to elucidate how Equation \eqref{eq:econst} is modified under the anelastic approximation for a general equation of state. It will be found that \textit{only} exchange between internal energy (due to heating) and kinetic energy is possible for an energetically constistent anelastic approximation. Conversion to and from potential energy, by contrast, is fundamentally impossible. This is essentially a new result, which has been overlooked for several decades, mainly because of the pathological coincidence that for a perfect, adiabatically stratified gas, the internal energy due to heating \textit{looks} exactly like a potential energy. For non-adiabatic stratification, or for an imperfect gas, the coincidence no longer holds, and the more general law for conservation of total energy that is derived here should be considered. 
	
The other new and related result is that total energy \textit{should} be conserved under the anelastic approximation, for arbitrary fluid motions and equations of state and for all stratifications, even for strongly subadiabatic ones. The anelastic equations of \citet{Gough1969} satisfy such a general conservation law, while modern implementations of the anelastic approximation do not. Thus, a major part of this paper is devoted to translating \citet{Gough1969}'s equations into more conventional notation and elucidating the origin and form of the term (which should be present in the internal energy equation for asymptotic consistency) that is missing from modern anelastic implementations. 

Finally, we note that \citet{Gough1969} assumed zero net vertical transport of mass for the ``true" fully compressible fluid whose motion the anelastic equations are intended to approximate. This may at first seem like an arbitrary choice to make the small-parameter expansion simpler. It is concluded in this work, however, that the ``zero mean mass flux" assumption is in fact fundamental to ensure the energetic consistency of the anelastic approximation. 
	
		Note that the left-hand side (LHS) of Equation \eqref{eq:en} can be written in several other forms which will prove useful: 
	\begin{subequations}\label{eq:enlhs}
		\begin{align}
			\pderiv{}{t}(\rho U) + \Div(\rho U\vecu) + P\Div\vecu &= \rho\matderiv{U} - \frac{P}{\rho}\matderiv{\rho}\\
			&= \rho\matderiv{h} -\matderiv{P}\\
			&=\rho T \matderiv{S},
		\end{align}
	\end{subequations}
	where 
	\begin{align}\label{eq:matderiv}
		\matderiv{}{}\define \pderiv{}{t} + \ugrad
	\end{align}
	is the material (or Lagrangian) derivative,
	\begin{align}\label{eq:enthalpy}
		h\define U + \frac{P}{\rho}
	\end{align}
	is the specific enthalpy, and
	\begin{align}\label{eq:entropy}
		S = S(P,T)
	\end{align}
	is the specific entropy. 
	
	It will also be helpful to define the following fluid properties associated with the generalized equations of state \eqref{eq:eos} and \eqref{eq:entropy}: the specific heat at constant pressure, 
	\begin{align}\label{eq:cp}
		\cpcap=\cpcap(P,T)\define T\left(\pderiv{S}{T}\right)_P,
	\end{align}
	the squared adiabatic sound speed,
	\begin{align}\label{eq:cs2}
		\cs^2=\cs^2(P,T)\define \left(\pderiv{P}{\rho}\right)_S,
	\end{align}
	and the thermal expansion coefficient,
	\begin{align}
		\delta=\delta(P,T)\define-\left(\pderiv{\ln\rho}{\ln T}\right)_P.
	\end{align}
	The first law of thermodynamics takes the following forms:
	\begin{subequations}\label{eq:firstlaw}
		\begin{align}
			TdS &= dU - \frac{P}{\rho^2}d\rho \\
			&= dh - \frac{dP}{\rho}\\
			&= \cpcap dT - \frac{\delta}{\rho}dP\\
			&=\frac{\cpcap T}{\rho\delta}\left[\frac{dP}{\cs^2}-d\rho\right].
		\end{align}
	\end{subequations}
	
	\section{The anelastic approximation of \citet{Gough1969}}
	We will not repeat the full asymptotic expansion in $\epsilon$ of Equations \eqref{eq:cont}, \eqref{eq:mom}, \eqref{eq:en}, and \eqref{eq:eos} here. Instead, we reiterate the salient assumptions in the case where the horizontally averaged background atmosphere is time-independent and the layer depth is thicker than the typical pressure scale height.\footnote{\citet{Gough1969} also considers thin layers, in which the anelastic equations become the Boussinesq equations, and time-dependent (moving) background atmospheres. Note that the assumption of time-independence can be relaxed slightly without affecting the asymptotics, as we discuss below.} The main assumption is that the thermodynamic perturbations from the horizontally averaged background state are small, e.g.,
	\begin{align}\label{eq:linearthermo}
		\rho = \rhoover(q) + \rhoone(x_i,t)\five &\with \rhoone/\rhoover=O(\epsilon)\ll 1,\\
		P = \prsover(q) + \prsone(x_i,t)\five &\with \prsone/\prsover=O(\epsilon)\ll1 \nonumber,
	\end{align} 
	and similarly for $T$, $U$, $h$, $\cpcap$, $\mu$, $\delta$, $\cs^2$, $\vecf$, and $Q$. Here, the overbars denote horizontal averages and the ``1" subscripts denote the perturbations about this average. Note that it is \textit{not} correct to write ``$S=\entrover(q)+\entrone(x_i,t)$ with $\entrone/\entrover=O(\epsilon)$." The fully compressible equations of motion contain only differences in entropy and so no meaningful absolute value of $\entrover$ can be defined. Instead, we must write
	\begin{align}\label{eq:linearent}
	S = \entrover(q) + \entrone(x_i,t) \five &\with \entrone/\cpover=O(\epsilon)\ll 1.
	\end{align} 
	The second assumption is that the coordinate system can be chosen such that there is no mass flux across any horizontal surface, i.e.,
	\begin{align}\label{eq:nomassflux}
		\overline{\rho u_i}=0.
	\end{align}
	In a spherical system, the horizontal average would be a spherically symmetric average and the coordinates would point along the spatially varying curvilinear coordinate directions. 
	
	The characteristic length scale of variation of the fluid is assumed to be a typical value $H_a$ for the pressure scale height. The flow is assumed to be buoyantly driven by the $O(\epsilon)$ thermal perturbations, i.e., 
	\begin{align}\label{eq:scaleu}
		|\vecu| = O(\sqrt{\epsilon g_a H_a}) = O(\sqrt{\epsilon}c_{{\rm s}a}),
	\end{align}
	where ``a" subscripts denote typical atmospheric background-state values. Thus, the squared Mach number of the flow is assumed to be $O(\epsilon)$. The characteristic time scale of variation of the fluid is assumed to be advective, i.e., 
	\begin{align}\label{eq:scaleu}
	\left|\pderiv{}{t}\right|  \define O\left(\sqrt{\frac{\epsilon g_a}{H_a}}\right) = O\left(\sqrt{\epsilon} \frac{1}{H_a/c_{{\rm s}a}}\right).
	\end{align}
	Thus, the characteristic time scale is $O(\epsilon^{-1/2})$ times longer than the time it takes a sound wave to cross a pressure scale height. 
	
	Finally, the vertical convective heat flux, which maximally could transport an energy flux of order $\rhoover \tmpover w \Delta\entrover$, where 
	\begin{align}\label{eq:defw}
		w\define\veck\cdot\vecu
	\end{align} is the vertical velocity and $\Delta \entrover $ is the total drop in background entropy across the convecting layer, is assumed to be limited primarily by the thermal diffusion $\vecf$. This will be true if the conductive heating $-\Div \vecf$ in Equation \eqref{eq:en} is at at least as large as the viscous and internal heatings. In the case of negligible heatings (high Rayleigh number), one expects
	\begin{align}
		\frac{\Delta\entrover}{C_{{\rm p}a}} = O(\epsilon),
	\end{align}
	i.e., the convecting layer should be nearly adiabatically stratified for vigorous convection. 
	
	One consequence of Equation \eqref{eq:nomassflux} is that the horizontally averaged velocity $\overline{\vecu}$ is $O(\epsilon)$ \textit{smaller} than the perturbed velocity $\vecu_1$. For the total mass flux (or equivalently, momentum density), $\bm{m}\define \rho\vecu=(\rhoover+\rhoone)(\overline{\vecu}+\vecu_1)$, we can thus write
		\begin{align}\label{eq:momdensityorig}
		\bm{m} = \bm{m}-\overline{\bm{m}}=\rhoover\vecu_1 + \rhoone\vecu_1 - \overline{\rhoone\vecu_1} + O(\epsilon^2).
	\end{align}
	Hence, at $O(\epsilon)$, only the perturbation velocity $\vecu_1$ appears in the equations, so we subsequently use $\vecu$ as shorthand for $\vecu_1$ and drop the subscript ``1." Under this convention,
\begin{align}\label{eq:nomeanu}
	\overline{\vecu}\equiv0
\end{align}
	and Equation \eqref{eq:momdensityorig} becomes
	\begin{align}\label{eq:momdensity}
		\bm{m} = \rhoover\vecu + \rhoone\vecu - \overline{\rhoone\vecu} + O(\epsilon^2).
	\end{align}
	Each of the two terms $\rhoone\vecu$ and $-\overline{\rhoone\vecu}$ are $O(\epsilon)$. In most cases, we can thus write $\bm{m} \approx \rhoover \vecu$ to translate from \citet{Gough1969} to the current notation (in which we use $\vecu$ as the primary field variable), except when multiplying by potentially zeroth-order quantities.
	
	 One other change in notation is that \citet{Gough1969} uses the superadiabatic mean background temperature gradient
	\begin{align}\label{eq:superad}
		\beta &\define -\frac{1}{\cpover}\veck\cdot\left[\nabla\overline{h}-\frac{1}{\rhoover}\nabla\prsover\right]\nonumber\\
		&=-\frac{\tmpover}{\cpover}\veck\dotgrad\entrover + O(\epsilon^2),
	\end{align}
	whereas we will use $\nabla \entrover$. 
	
	Once all of the above scaling assumptions have been made, Equations \eqref{eq:cont}, \eqref{eq:mom}, \eqref{eq:en}, and \eqref{eq:eos} are nondimensionalized, each term is expanded in powers of $\epsilon$, terms up to zeroth-order in the continuity equation and first-order in the other equations are retained, and redimensionalization then yields the anelastic equations. Specifically, we discuss Equations (4.3)--(4.7) and(4.15)--(4.22) from \citet{Gough1969}. We translate these equations using the change of variables outlined in Equations \eqref{eq:momdensity} and \eqref{eq:superad}. 
	
	Under \citet{Gough1969}'s anelastic approximation, the continuity equation \eqref{eq:cont} becomes
	\begin{align}\label{eq:ancont}
		\Div(\rhoover\vecu)\equiv 0,
	\end{align}
	the momentum equation \eqref{eq:mom} becomes 
	\begin{subequations}\label{eq:anmom}
	\begin{align}
		\pderiv{}{t}(\rhoover\vecu)&=-\Div(\rhoover\vecu\vecu) - \nabla \prsone +\rhoone\vecg +\Div \overleftrightarrow{D}+[-\nabla\prsover + \rhoover\vecg],\label{eq:anmommain}\\
		\text{where now}\five D_{ij}& = \overline{\mu}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} - \frac{2}{3}(\Div\vecu)\delta_{ij}\right)\label{eq:anmomvisc},
	\end{align}
	\end{subequations}
	the energy equation \eqref{eq:en} becomes 
	\begin{align}\label{eq:anen}
		\rhoover\cpover\pderiv{\tmpone}{t} - \deltaover\pderiv{\prsone}{t} = &-\rhoover\vecu\cdot\left(\nabla \enthone-\frac{1}{\rhoover}\nabla \prsone\right) - \rhoover \tmpover \ugrad \entrover\nonumber\\
		& D_{ij}\pderiv{u_i}{x_j} + Q _1- \Div\vecf_1 -\rhoone\vecu\cdot\vecg - \tmpover(\rhoone\vecu-\overline{\rhoone\vecu})\cdot\nabla\entrover\nonumber\\
		&+ [\heatover - \Div\overline{\vecf}],
	\end{align}
	%-\nabla(\rhoover \overline{w^2}) 
  and the equation of state \eqref{eq:eos} becomes linearized, with
  \begin{subequations}\label{eq:aneos}
  \begin{align}
  	\tmpover \entrone &= \cpover \tmpone - \frac{\deltaover}{\rhoover} \prsone\label{eq:lintp}\\
  	&= U_1 - \frac{\prsover}{\rhoover^2}\rhoone \label{eq:linu}\\
  	&= \enthone - \frac{\prsone}{\rho}\\
  	&= \frac{\cpover\, \tmpover}{\deltaover\rhoover}\left[\frac{\prsone}{\cssqover}-\rhoone\right].
  \end{align}
  \end{subequations}
  We have used Equation \eqref{eq:momdensity} to yield the term $- \tmpover(\rhoone\vecu-\overline{\rhoone\vecu})\cdot\nabla\entrover$ in Equation \eqref{eq:anen}. 
  
   The differentials in Equation \eqref{eq:firstlaw} can be converted into gradients (e.g., $T\nabla S= \nabla h - \nabla P/\rho$) and the horizontally averaged form of these relations yields 
  \begin{subequations}\label{eq:anfirstlaw}
  	\begin{align}
  		\tmpover\nabla\entrover &= \cpover\nabla\tmpover - \frac{\deltaover}{\rhoover}\nabla\prsover + O(\epsilon^2)\\
  		&= \frac{\cpover\,\tmpover}{\deltaover\rhoover}\left[\frac{\nabla\prsover}{\cssqover}-\nabla\rhoover\right]+O(\epsilon^2).
  	\end{align}
  \end{subequations}
  
   The horizontal averages of Equations \eqref{eq:anmom} and \eqref{eq:anen} satisfy 
  \begin{align}\label{eq:anmeanmom}
  	-\nabla\prsover + \rhoover\vecg = \nabla(\rhoover \overline{w^2})
  \end{align}
  and
  \begin{align}\label{eq:anmeanen}
  	\heatover - \Div\overline{\vecf} = \rhoover\overline{\vecu\cdot\left(\nabla \enthone-\frac{1}{\rhoover}\nabla \prsone\right)} + \vecg\cdot\overline{\rhoone\vecu} - \overline{D_{ij}\pderiv{u_i}{x_j}}
  \end{align}
   Equations \eqref{eq:ancont}--\eqref{eq:anmeanen} are mathematically equivalent to Equations (4.3)--(4.7) and (4.15)--(4.22) from \citet{Gough1969}.
  
  In each of Equations \eqref{eq:anmeanmom} and \eqref{eq:anmeanen}, each term on the right-hand side (RHS) is $O(\epsilon)$ compared to each term on the LHS. In particular, we can approximate 
  \begin{align}\label{eq:anhydrostatic}
  	\nabla\prsover\approx \rhoover\vecg
  \end{align}
  in terms that are already of first order in $\epsilon$. 
  
Dotting $\vecu$ into Equation \eqref{eq:anmommain} and using Equation \eqref{eq:anmeanmom} yields the anelastic kinetic energy equation,
	\begin{align}\label{eq:anke}
		\pderiv{}{t}\left(\frac{1}{2}\rhoover u^2\right)&=-\Div\left(\frac{1}{2}\rhoover u^2\vecu \right) - \ugrad \prsone + \rhoone\vecu\cdot\vecg + u_i\pderiv{D_{ij}}{x_j} + \ugrad(\rhoover \overline{w^2}).
	\end{align}

 Note that from Equation \eqref{eq:lintp}, the LHS of Equation \eqref{eq:anen} can be written in terms of the entropy $\entrone$, 
\begin{align}\label{eq:anenlhs}
	\rhoover\cpover\pderiv{\tmpone}{t} - \deltaover\pderiv{\prsone}{t} = \rhoover\tmpover\pderiv{\entrone}{t}.
\end{align}

Using Equations \eqref{eq:ancont}, \eqref{eq:aneos}, and \eqref{eq:anenlhs} and then adding Equations \eqref{eq:anen} and \eqref{eq:anke} yields \citet{Gough1969}'s total energy equation,
\begin{align}\label{eq:antote}
			\pderiv{}{t}\left[\rhoover\left(\frac{1}{2} u^2 + \tmpover \entrone\right)\right] = &-\Div\left\{\left[\rhoover\left(\frac{1}{2} u^2 + \tmpover \entrone\right) + \prsone\right]\vecu- \vecu\cdot\overleftrightarrow{D} + \overline{\vecf} + \vecf_1\right\}+ \heatover + Q_1 \nonumber\\
			 &+\left[-\rhoover\tmpover\ugrad\entrover +\ugrad (\rhoover \overline{w^2})- \tmpover(\rhoone\vecu-\overline{\rhoone\vecu})\cdot\nabla\entrover\right].
\end{align}
Because of Equation \eqref{eq:nomeanu}, or more specifically, the condition
\begin{align}\label{eq:nomeanw}
	\overline{w}\equiv0,
\end{align}
 each of the rightmost terms in brackets in Equation \eqref{eq:antote} cannot transport any net energy across the layer. Note that Equation \eqref{eq:nomeanw} is also a consequence of integrating Equation \eqref{eq:ancont} over volumes bounded by horizontal surfaces, and so the vanishing of the horizontal components of $\overline{\vecu}$ is not strictly necessary for the bracketed terms to conserve energy. 
 
 The internal heating (or cooling) terms $\heatover + Q_1$ are assumed ``accounted for," since they represent known physical processes such as nuclear burning, Kelvin-Helmholtz contraction, or radiative cooling. Thus, Equation \eqref{eq:antote} shows that the total energy integrated over the volume $V$ of the layer,
\begin{align}\label{eq:deftote}
	E_{\rm tot} \define \int_V \rhoover\left(\frac{1}{2} u^2 + \tmpover \entrone\right) dV,
\end{align}
is conserved, to the extent that the volume-integrated internal heat sources balance the various fluxes (found under the divergence on the RHS of Equation \eqref{eq:antote}) integrated over the boundaries. This conservation holds for arbitrary fluid motions that obey Equations \eqref{eq:ancont}, \eqref{eq:anmom}, \eqref{eq:anen}, and \eqref{eq:aneos} and for arbitrary magnitudes of $|\nabla \entrover|$. However, whether the approximation remains \textit{consistent} (i.e., whether the thermal perturbations remain small) \textit{does} depend on the magnitude of $|\nabla\entrover|$.

\section{The \citet{Gough1969} equations in more familiar form}
Modern anelastic codes typically write the equations using the perturbed pressure and entropy ($\prsone$ and $\entrone$) in place of the quantities $\tmpone$, $\prsone$, $\rhoone$, and $\enthone$ that appear in Equations \eqref{eq:anmom} and \eqref{eq:anmeanmom}. We can convert using Equations \eqref{eq:aneos} and \eqref{eq:anfirstlaw} and the approximation \eqref{eq:anhydrostatic}. In the momentum equation, we find
\begin{align}\label{eq:anrhsmom}
	-\nabla \prsone + \rhoone\vecg = -\rhoover\nabla\left(\frac{\prsone}{\rhoover}\right) - \deltaover \rhoover \left(\frac{\entrone}{\cpover}\right) \vecg + \frac{\deltaover\rhoover}{\cpover} \left(\frac{\prsone}{\rhoover}\right)\nabla\entrover.
\end{align}
In the internal energy equation, we find
\begin{align}\label{eq:anrhsen}
	-\rhoover\vecu\cdot\left(\nabla \enthone-\frac{1}{\rhoover}\nabla \prsone\right) = -\rhoover\tmpover\ugrad \entrone - \rhoover \entrone\ugrad\tmpover + \left(\frac{\prsone}{\rhoover}\right)\ugrad \rhoover.
\end{align}
Using Equations \eqref{eq:aneos}, \eqref{eq:anfirstlaw}, and \eqref{eq:anhydrostatic} as needed, we compute, with some effort,
\begin{align}\label{eq:anrhsen2}
	- \rhoover \entrone\ugrad\tmpover + \left(\frac{\prsone}{\rhoover}\right)\ugrad \entrone -\rhoone\vecu\cdot\vecg = -\rhoover \tmpone\ugrad\entrover + O(\epsilon^2).
\end{align}

Substituting Equation \eqref{eq:anrhsmom} into Equation \eqref{eq:anmom}, and Equations \eqref{eq:anenlhs}, \eqref{eq:anrhsen}, and \eqref{eq:anrhsen2} into Equation \eqref{eq:anen}, we find
	\begin{align}\label{eq:anmommod}
		\pderiv{}{t}(\rhoover\vecu)= &-\Div(\rhoover\vecu\vecu) -\rhoover\nabla\left(\frac{\prsone}{\rhoover}\right) - \deltaover \rhoover \left(\frac{\entrone}{\cpover}\right) \vecg + \underbrace{\frac{\deltaover \prsone}{\cpover} \nabla\entrover}_{\define \bm{f}_{\rm NLBR}}+\Div \overleftrightarrow{D}\nonumber\\
		&+[-\nabla\prsover + \rhoover\vecg],
	\end{align}
and
\begin{subequations}\label{eq:anenmod}
\begin{align}
	\rhoover\tmpover\pderiv{\entrone}{t}= &-\rhoover\tmpover\ugrad \entrone - \rhoover \tmpover \ugrad \entrover \underbrace{- \rhoover \tmpone\ugrad\entrover}_{\define Q_{\rm NLBR}}+D_{ij}\pderiv{u_i}{x_j} + Q _1- \Div\vecf_1  \nonumber\\
	& +[\heatover - \Div\overline{\vecf} - \tmpover(\rhoone\vecu-\overline{\rhoone\vecu})\cdot\nabla\entrover],\\
	\where \rhoone =& \frac{\prsone}{\cssqover}-\frac{\deltaover\rhoover \entrone}{\cpover}\\
	\andd \tmpone = & \frac{\tmpover \entrone}{\cpover} + \frac{\deltaover \prsone}{\rhoover\cpover}.
\end{align}
\end{subequations}
Finally, the mean energy equation \eqref{eq:anmeanen} becomes
\begin{align}\label{eq:anmeanen2}
	\heatover-\Div\overline{\vecf} = \rhoover\tmpover\, \overline{\ugrad \entrone}-\overline{D_{ij}\pderiv{u_i}{x_j}} + \rhoover (\overline{\tmpone\vecu})\dotgrad\entrover 
\end{align}
%The final terms in brackets in these equations may be dropped without affecting energy conservation, since they do not transport any net energy. However, dropping them still may still makes the equations an asymptotically inconsistent approximation to the true fully compressible motion, and so we retain them.

The essential terms required for energy conservation when $\nabla\entrover\neq0$ are the ``non-LBR" force density
\begin{align}\label{eq:nlbrmom}
	\bm{f}_{\rm NLBR} \define \frac{\deltaover \prsone}{\cpover} \nabla\entrover
\end{align}
and the ``non-LBR" heating
\begin{align}\label{eq:nlbrheat}
	Q_{\rm NLBR} \define -\rhoover \tmpone\ugrad\entrover.
\end{align}
Both these terms vanish for an adiabatic background state (where $\nabla\entrover=0$), which is expected for a fully (and sufficiently vigorously) convecting fluid layer.  Neglecting $\bm{f}_{\rm NLBR}$ was first done independently by \citet{Lantz1992} and \citet{Braginsky1995} and is referred as the ``Lantz-Braginsky-Roberts" (LBR) approximation. The term $Q_{\rm NLBR}$ in the internal energy equation, which was implicitly contained in the equations of \citet{Gough1969}, seems to be absent in the other forms of the anelastic equations currently in use,ts neglect seems to have not been explicitly considered. 

\section{The equivalence of horizontally averaged atmospheres to fixed reference atmospheres}
In the formalism of \citet{Gough1969}, the horizontally averaged atmosphere, denoted by the overbars, cannot be specified a priori because it depends on the ultimate flow via Equations \eqref{eq:anmeanmom} and \eqref{eq:anmeanen}. Many anelastic numerical codes (e.g., the {\rayleigh}, {\eulag}, and \texttt{MagIC} codes, which simulate the anelastic equations in spherical shells) instead treat the background state as a fixed-in-time, spherically symmetric, hydrostatic ``reference" state and let the perturbations in $S$ and $P$ about this reference state develop small but nonzero horizontally averaged pertrubations. Some codes (e.g., the {\ash} code) alternatively solve for the perturbations about the horizontal average directly. In the latter approach, horizontally averaged terms like the bracketed terms in Equations \eqref{eq:anmom} and \eqref{eq:anen} are retained on the RHS's of the momentum and energy equations. As we now show, these two approaches are exactly equivalent to the order of the anelastic equations, provided that the horizontal means of the thermal variables do not wander by more than $O(\epsilon)$ away from their preordained reference state values. 

Our approach is to define the horizontally averaged profiles as the sum of the reference-state profile (denoted by a tilde) and a horizontally symmetric deviation (denoted by a hat):
\begin{align}
\prsover=	\prsover(q,t) &= \tilde{P}(q) + \prshat(q,t) ,\\
\rhoover=	\rhoover(q,t)  &= \rhotilde(q)  + \rhohat(q,t) ,\\
	\entrover = \entrover (q,t) &=  \tilde{S}(q)  + \entrhat(q,t) ,
\end{align}
etc., where we assume (apart from the entropy) that the hatted means are $O(\epsilon)$ compared to the reference-state means. Note that the horizontal mean profiles are now time-dependent. This does not affect the asymptotic expansion leading to Equations \eqref{eq:ancont}, \eqref{eq:anmommod}, and \eqref{eq:anenmod}, provided the time derivatives of the mean state are the same order as the time derivatives of the deviations [e.g., $\pderivline{\rhoover}{t}=O(\pderivline{\rhoone}{t})$]. Most reference-state profiles are chosen to be time-independent, except for $\tilde{Q}$ and $\tilde{\vecf}$ (see below). 

We assume that the reference state is chosen to be hydrostatic,
\begin{align}\label{eq:refhydro}
	\nabla \tilde{P} = \rhotilde\vecg
\end{align}
and that it satisfies the first law of thermodynamics for gradients (compare to Equation \eqref{eq:anfirstlaw}),
\begin{subequations}\label{eq:anfirstlawref}
	\begin{align}
		\tilde{T}\nabla\tilde{S} &= \tilde{\cpcap}\nabla\tilde{T} - \frac{\tilde{\delta}}{\rhotilde}\nabla\tilde{P} \\
		&= \frac{\tilde{\cpcap}\tilde{T}}{\tilde{\delta}\rhotilde}\left[\frac{\nabla\tilde{P}}{\tilde{\cs^2}}-\nabla\rhotilde\right].
	\end{align}
\end{subequations}
We choose the reference heating and conductive profile to satisfy
\begin{align}\label{eq:dsdt}
	\tilde{Q} - \Div\tilde{\vecf} \define -\rhotilde\tilde{T}\pderiv{\entrhat}{t}.
\end{align}
Note that this is simply a \textit{definition} for the reference-state term $\tilde{Q}-\Div\tilde{\vecf}$, which can be time-dependent, as long as it is horizontally symmetric and $O(\epsilon)$.

We denote the (temporally and horizontally dependent) deviations from the reference state by primes and note that 
\begin{align}
	\prsprime & \define P - \tilde{P} = \prsone + \prshat,\\
	\rhoprime & \define \rho - \rhotilde = \rhoone + \rhohat,\\
	 \entrprime & \define S -  \tilde{S} =  \entrone + \entrhat,
\end{align}
etc. The primed quantities (except for the entropy) are thus $O(\epsilon)$ compared to the reference-state means, since they are the sum of two $O(\epsilon)$ perturbations. 
%	&= h^\prime - \frac{\prsprime }{\rhotilde}\\
% 		&= U^\prime - \frac{\tilde{P}}{\rhotilde^2}\rhoprime \\

The linearized equation of state for the primed quantities is exactly analogous to Equation \eqref{eq:aneos},
\begin{subequations}\label{eq:aneosref}
	\begin{align}
		\tilde{T} \entrprime &= \tilde{\cpcap} \tmpprime - \frac{\tilde{\delta}}{\rhotilde} \prsprime,\\
  	&= U^\prime - \frac{\prstilde}{\rhotilde^2}\rhoprime \label{eq:linuref}\\
&= \enthprime - \frac{\prsprime}{\rhotilde}\\
		&= \frac{\tilde{\cpcap} \tilde{T}}{\tilde{\delta}\rhotilde}\left[\frac{\prsprime}{\tilde{\cs^2}}-\rhoprime\right].
	\end{align}
\end{subequations}
as is the linearized equation of state for the hatted quantities. Note that in Equation \eqref{eq:aneos}, the overbars may be replace by tildes, making Equation \eqref{eq:aneosref} applicable to the ``subscript 1" quantities as well. 

To zeroth order in $\epsilon$, Equation \eqref{eq:ancont} becomes simply
\begin{align}\label{eq:ancontref}
	\Div(\rhotilde\vecu)\equiv0.
\end{align}
Because the RHS of Equations \eqref{eq:anmom} is $O(\epsilon)$ compared to the LHS we can write, using Equation \eqref{eq:refhydro},
\begin{align}\label{eq:anrhsmomref}
	[-\nabla \prsover + \rhoover\vecg] &= -\nabla \prshat + \rhohat\vecg\nonumber\\
	&= -\rhotilde\nabla\left(\frac{\prshat}{\rhotilde}\right) - \tilde{\delta} \rhotilde \left(\frac{\entrhat}{\tilde{\cpcap}}\right) \vecg + \frac{\tilde{\delta}\rhotilde}{\tilde{\cpcap}} \left(\frac{\prshat}{\rhotilde}\right)\nabla\tilde{S}.
\end{align}
Note that the non-LBR force density from Equation \eqref{eq:nlbrmom} is only significant when $\nabla\entrover$ is large (in which case $\nabla\entrover=\nabla\tilde{S}+O(\epsilon)$), otherwise it is $O(\epsilon^2)$. For all magnitudes of $|\nabla\entrover|$, we can thus write
\begin{align}\label{eq:nlbrmom2}
	\bm{f}_{\rm NLBR} = \frac{\deltaover \prsone}{\cpover} \nabla\tilde{S} + O(\epsilon^2)
\end{align}
Plugging Equations \eqref{eq:anrhsmomref} and \eqref{eq:nlbrmom2} into Equation \eqref{eq:anmommod} and noting that all terms are of $O(\epsilon)$ (so that we can replace overbars with tildes), we find
\begin{subequations}\label{eq:anmomref}
	\begin{align}\label{eq:anmomrefmain}
	\pderiv{}{t}(\rhotilde\vecu)= &-\Div(\rhotilde\vecu\vecu) -\rhotilde\nabla\left(\frac{\prsprime}{\rhotilde}\right) - \tilde{\delta}\rhotilde \left(\frac{\entrprime}{\tilde{\cpcap}}\right) \vecg +\frac{\tilde{\delta} \prsprime}{\tilde{\cpcap}} \nabla\tilde{S}+\Div \overleftrightarrow{D},\\
	\text{where now}\five D_{ij}& = \tilde{\mu}\left(\pderiv{u_i}{x_j} + \pderiv{u_j}{x_i} - \frac{2}{3}(\Div\vecu)\delta_{ij}\right)\label{eq:anmomrefvisc},
\end{align}
\end{subequations}
%In the internal energy equation \eqref{eq:anenmod}, we write 

Using Equation \eqref{eq:nomeanu}, Equation \eqref{eq:momdensity} can be additionally written
  \begin{align}\label{eq:momdensity2}
\rhoover\vecu + \rhoone\vecu - \overline{\rhoone\vecu} = \rhotilde\vecu + \rhoprime\vecu - \overline{\rhoprime\vecu} + O(\epsilon^2).
\end{align}
We finally write 
\begin{align}
	Q_{\rm NLBR} = -\rhotilde \tmpone\ugrad\tilde{S} + O(\epsilon^2)
\end{align}
and 
\begin{align}\label{eq:anenrhsfinal}
	-\rhoover\tmpover \ugrad \entrone - \rhoover\tmpover \ugrad\entrover &= - \rhoover\tmpover\ugrad \entrprime -\rhoover\tmpover\ugrad\tilde{S} \nonumber\\
	&=-\rhotilde\tilde{T}\ugrad \entrprime - \tilde{T}(\rhoover \vecu)\cdot\nabla\tilde{S} - \rhotilde\tmphat\ugrad\tilde{S} + O(\epsilon^2).
\end{align}
Substituting Equation \eqref{eq:dsdt} and Equations \eqref{eq:momdensity2} through \eqref{eq:anenrhsfinal} into Equation \eqref{eq:anenmod} yields
\begin{subequations}\label{eq:anenref}
	\begin{align}
		\rhotilde\tilde{T}\pderiv{\entrprime}{t}= &-\rhotilde\tilde{T}\ugrad \entrprime - \rhotilde\tilde{T} \ugrad \tilde{S} - \rhotilde \tmpprime\ugrad\tilde{S}+D_{ij}\pderiv{u_i}{x_j} + Q^\prime- \Div\vecf^\prime  \nonumber\\
		& - \tilde{T}(\rhoprime \vecu-\overline{\rhoprime\vecu})\cdot\nabla\tilde{S},\label{eq:anenrefmain}\\
		\where \rhoprime =& \frac{\prsprime}{\tilde{\cs^2}}-\frac{\tilde{\delta}\rhotilde S ^\prime}{\tilde{\cpcap}},\\
		 \tmpprime = & \frac{\tilde{T} \entrprime}{\tilde{\cpcap}} + \frac{\tilde{\delta} \prsprime}{\rhotilde\tilde{\cpcap}},
	\end{align}
\end{subequations}
and $D_{ij}$ is now given by Equation \eqref{eq:anmomrefvisc}. 

Taking the horizontal means of Equations \eqref{eq:anmomref} and \eqref{eq:anenref} and then using Equations \eqref{eq:refhydro}, \eqref{eq:dsdt}, and \eqref{eq:anrhsmomref} recovers the mean momentum and energy equations \eqref{eq:anmeanmom} and \eqref{eq:anmeanen2}. The anelastic formulation with fixed reference states (Equations \eqref{eq:ancontref}, \eqref{eq:anmomref} and \eqref{eq:anenref}) is thus seen to be asymptotically equivalent to the formulation with horizontally averaged background states (Equations \eqref{eq:ancont}, \eqref{eq:anmommod}, and \eqref{eq:anenmod}, combined with Equations \eqref{eq:anmeanmom} and \eqref{eq:anmeanen}). 

\section{The Anelastic Energy-conserving Generalized Gough (AnEGG) approximation}
To arrive at the final form of an energy-conserving set of anelastic equations, we make one final argument: that the last term in Equation \eqref{eq:anenrefmain} is negligible. We do so because this term has zero horizontal mean and therefore cannot affect the net transport of energy. Furthermore, pointwise it should always be much smaller than the background advection term $-\rhotilde\tilde{T}\ugrad\tilde{S}$, provided $\rhoprime$ remains $\ll \rhotilde$.

The final equations, representing what we call the Anelastic Energy-conserving Generalized Gough (AnEGG) approximation, are thus
\begin{subequations}\label{eq:anegg}
\begin{empheq}[box=\fbox]{align}
	\Div(\rhotilde\vecu)&\equiv 0\label{eq:ancontegg},\\
	\pderiv{}{t}(\rhotilde\vecu)&=-\Div(\rhotilde\vecu\vecu) -\rhotilde\nabla\left(\frac{\prsprime}{\rhotilde}\right) - \tilde{\delta}\rhotilde \left(\frac{\entrprime}{\tilde{\cpcap}}\right) \vecg \underbrace{+ \frac{\tilde{\delta} \prsprime}{\tilde{\cpcap}} \nabla\tilde{S}}_{\define \tilde{\bm{f}}_{\rm NLBR}}+\Div \overleftrightarrow{D},\label{eq:anmomegg}\\	
		\andd \rhotilde\tilde{T}\pderiv{\entrprime}{t}&= -\rhotilde\tilde{T}\ugrad \entrprime - \rhotilde\tilde{T} \ugrad \tilde{S} \underbrace{ -  \left(\frac{\tilde{T} \entrprime}{\tilde{\cpcap}} + \frac{\tilde{\delta} \prsprime}{\rhotilde\tilde{\cpcap}}\right)  \rhotilde \ugrad\tilde{S} }_{\define \tilde{Q}_{\rm NLBR}} \nonumber\\
		&\ \ \ \ +D_{ij}\pderiv{u_i}{x_j} + Q^\prime- \Div\vecf^\prime,\label{eq:anenegg}
\end{empheq}
\end{subequations}
where $\overleftrightarrow{D}$ is defined in Equation \eqref{eq:anmomrefvisc}. %and it is additionally assumed that the fixed reference state satisfies the hydrostatic condition \eqref{eq:refhydro} and the first law of thermodynamics in gradient form, Equation \eqref{eq:anfirstlawref}. 

The AnEGG kinetic energy equation, derived from $\vecu$ dotted into Equation \eqref{eq:anmomegg}, is 
%\begin{equation}\label{eq:ankeref}
	\begin{empheq}[box=\fbox]{align}\label{eq:ankeegg}
	\pderiv{}{t}\left(\frac{1}{2}\rhotilde u^2\right)&=-\Div\left(\frac{1}{2}\rhotilde u^2\vecu \right) - \Div(\prsprime\vecu)  - \tilde{\delta}\rhotilde \left(\frac{\entrprime}{\tilde{\cpcap}}\right) \vecu\cdot \vecg +\frac{\tilde{\delta} \prsprime}{\tilde{\cpcap}} \vecu\cdot \nabla\tilde{S}  + u_i\pderiv{D_{ij}}{x_j},
	\end{empheq}
%\end{equation}
Adding Equations \eqref{eq:anenegg} and \eqref{eq:ankeegg} yields the AnEGG total energy equation,
\begin{empheq}[box=\fbox]{align}\label{eq:antoteref}
	\pderiv{}{t}\left[\rhotilde\left(\frac{1}{2} u^2 + \tilde{T} \entrprime \right)\right] = &-\Div\left\{\left[\rhotilde\left(\frac{1}{2} u^2 + \tilde{T} \entrprime\right) + \prsprime \right]\vecu- \vecu\cdot\overleftrightarrow{D} + \vecf^\prime \right\} + Q^\prime \nonumber\\ & -\rhotilde\tilde{T}\ugrad\tilde{S}. 
\end{empheq}
Again using condition \eqref{eq:nomeanu} (or equivalently, Equation \eqref{eq:ancontref}), the integration of Equation \eqref{eq:antoteref} yields conservation of total energy,

\begin{subequations}\label{eq:anrefeconst}
\begin{empheq}[box=\fbox]{align}
E_{\rm tot} &\define \int_V W_{\rm tot} dV = \text{constant},\\
\where W_{\rm tot} &\define \rhotilde\left(\frac{1}{2} u^2 + \tilde{T} \entrprime\right)
\end{empheq}
\end{subequations}
is the total energy density per unit volume. This conservation law holds for arbitrary fluid motions obeying Equations \eqref{eq:anegg} and for all magnitudes of $|\nabla\entrover|$. 

Note that in practice when simulating stiff systems (large $|\nabla\tilde{S}|$) numerically (e.g., \citealt{Guerrero2016a,Matilsky2022,Matilsky2024}), the term 
\begin{align}
	\tilde{Q}_{\rm adv}\define  -\rhotilde\tilde{T}\ugrad\tilde{S}
\end{align}
may pointwise be quite large. The degree to which energy is conserved numerically may thus be limited by the precision of the condition \eqref{eq:nomeanw}. In the streamfunction formulation of {\ash} and {\rayleigh} for example (e.g., \citealt{Clune1999,Featherstone2016a}), Equation \eqref{eq:nomeanw} holds to near machine precision. 

To summarize, necessary conditions for anelastic codes implementing background stable layers to conserve energy are (1) including the non-LBR force density,
\begin{align}\label{eq:nlbrmomref}
	\tilde{\bm{f}}_{\rm NLBR} \define\frac{\tilde{\delta} \prsprime}{\tilde{\cpcap}} \vecu\cdot \nabla\tilde{S} 
\end{align}
in the momentum equation (i.e., not making the LBR approximation) and (2) including the non-LBR heating term,
\begin{align}\label{eq:nlbrheatref}
	\tilde{Q}_{\rm NLBR} \define -  \left(\frac{\tilde{T} \entrprime}{\tilde{\cpcap}} + \frac{\tilde{\delta} \prsprime}{\rhotilde\tilde{\cpcap}}\right)  \rhotilde \ugrad\tilde{S}
\end{align}
in the internal energy equation. Alternatively, if the LBR approximation is made, (setting $\tilde{\bm{f}}_{\rm NLBR}\equiv0$ in Equation \eqref{eq:anmomref}), energy can still be conserved if $\tilde{Q}_{\rm NLBR}$ in Equation \eqref{eq:anenref} is replaced by
\begin{align}\label{eq:lbrheating}
	\tilde{Q}_{\rm LBR}\define - \left(\frac{\rhotilde\tilde{T}}{\tilde{\cpcap}} \right) \entrprime\ugrad\tilde{S}
\end{align}
However, doing this would still yield an asymptotically inconsistent equation set if $|\nabla\tilde{S}|$ is large. 

One slightly surprising result concerns the second law of thermodynamics. In the absence of heat sources or sinks, when the true motion should be adiabatic, Equation \eqref{eq:anenegg} becomes
\begin{align}\label{eq:dsdtref}
	\frac{D}{Dt}(\tilde{S} + \entrprime) = \frac{Q_{\rm NLBR}}{\rhotilde\tilde{T}}.
\end{align}
Thus, the AnEGG equations do not conserve total entropy for adiabatic motion, violating the second law of thermodynamics if $\entrprime$ is strictly interpreted as the entropy. Apparently making the anelastic approximation allows for the conservation of energy or the second law of thermodynamics to be satisfied, but not both. 

\section{The meaning of total energy under the anelastic approximation}
From Equation \eqref{eq:linuref}, the primed (i.e., perturbed from the reference state) internal plus potential energy per unit volume is 
\begin{align}\label{eq:perten1}
	W^\prime &= \tilde{U}\rhoprime + \rhotilde U^\prime + \Phi \rhoprime \nonumber\\
	&= \underbrace{\rhotilde\tilde{T} \entrprime}_{\define \wpheat} + \underbrace{\left(\tilde{U}+\frac{\tilde{P}}{\rhotilde}+\Phi\right)\rhoprime}_{\define\wpcomp}.
\end{align}

Equation \eqref{eq:linuref} is really an expression of the first law of thermodynamics, which states that changes in the internal energy of fluid parcels come from the sum of external heating and pressure work done by the environment during compression. Comparing to Equation \eqref{eq:econst}, it is clear that \textit{only} changes in internal energy from heat sources can effect the total energy. The changes in internal energy from density variations ($\intetilde\rhoprime$) the pressure work, $\prstilde(\rhoprime/\rhotilde)$; and the changes in potential energy, $\Phi\rhoprime$; are all absent. Since all three of these latter effects are due to density variations (i.e., compression or expansion of the fluid), we write
\begin{subequations}\label{eq:perten2}
	\begin{align}
		W^\prime &= \wpheat + \wpcomp,\\
		\where \wpheat&\define \rhotilde\tmptilde \entrprime\\
		\andd \wpcomp &\define \left(\intetilde+\frac{\prstilde}{\rhotilde}+\Phi\right)\rhoprime
	\end{align}
\end{subequations}

We note that
\begin{align}\label{eq:wcomp0}
	\wpcomp\equiv0\five\text{under the anelastic approximation},
\end{align}
i.e., \textit{no} compression effects can alter the total energy of the fluid at a particular vertical level.

A possibly deeper interpretation of Equation \eqref{eq:wcomp0} is that the assumption of zero mean mass flux, Equation \eqref{eq:nomassflux}, is \textit{fundamental} if the anelastic approximation is to be energetically consistent. For the ``true" (i.e., fully compressible) fluid, Equation \eqref{eq:nomassflux} applied to the continuity equation \eqref{eq:cont} yields
\begin{align}
	\pderiv{\rhoover}{t}\equiv0,
\end{align}
i.e., there can be no
Evidently from Equation \eqref{eq:deftote}, the internal energy (as far as energy transport is concerned) becomes simply $\rhoover\tmpover \entrprime$ and the potential energy is eliminated entirely. Both effects are consequences of the assumption of zero mean mass flux, Equation \eqref{eq:nomassflux}. This also has the consequence that $\entrprime$ should be interpreted as a deviation of internal energy from the mean, rather than as an entropy. 

\citet{Ogura1962} write
\begin{align}\label{eq:pertenogura}
	W_1 &= -\rhoover\Phi\left(\frac{\entrprime}{\cpcap}\right)+\rhoover\cvcap\tmpover_0\left(\frac{\prsprime}{\prsover}\right)\nonumber\\
	&=  -\rhoover\Phi\left(\frac{\entrprime}{\cpcap}\right)+\frac{\prsprime}{\gamma-1}
\end{align}
where the gas here is assumed to be perfect (i.e., $\overline{\cpcap}\equiv\cpcap$ and $\overline{\cvcap}\equiv\cvcap$, where $\cpcap$ and $\cvcap$ are constants and $\gamma\define\cpcap/\cvcap$) and adiabatically stratified ($\nabla\entrover\equiv0$), and the gravitational potential $\Phi$ is measured from the location $q_0$ where $\tmpover(q=q_0)\define \tmpover_0$  is equal to the assumed-constant background potential temperature.\footnote{See the equation immediately following Equation (31) from \citet{Ogura1962}. To see the equivalence to our Equation \eqref{eq:pertenogura}, note that \citet{Ogura1962} use $\theta$ for the non-dimensional order-unity perturbed potential temperature, $gz^\prime$ for the gravitational potential, and $\Theta$ for the constant (dimensional) potential temperature (equal to $\tmpover_0$) of the adiabatically stratified background. Also note the relation $\entrprime=\epsilon\cpcap\theta$.}

\citealt{Eckart1960} (p. 54) discussed the energy density associated with small perturbations about a background static atmosphere and identified $\prsone^2/(2\rhoover\cssqover)$ as the ``elastic" energy density from acoustics (\citealt{Morse1948}, p. 237). \citealt{Ogura1962} note that the The disappearance of the compressive term, which was called the ``elastic energy" in \citet{Eckart1956}, is the origin of the term ``anelastic," coined by Jule Charney (see ). The potential energy term also disappears, which is a direct consequence of the assumption of zero mean mass flux, Equation \eqref{eq:nomassflux}. 
%For a perfect gas [$U=\cvcap T$ and $P=(\cpcap-\cvcap)\rho T)$, with constant specific heats] with a hydrostatic, adiabatic mean background state satisfying Equations \eqref{eq:anfirstlaw} and \eqref{eq:anhydrostatic}, we have
%\begin{align}\label{eq:tmppot}
%	\Phi = -\cpcap \tmpover + K,
%\end{align}
%where $K$ is a constant. Equation \eqref{eq:perten1} then becomes
%\begin{align}\label{eq:perten2}
%	W_1 = - \frac{\rhoover\Phi}{\cpcap}\entrone + K\frac{\prsone}{\cssqover}
%\end{align}
%The disappearance of the compressive term, which was called the ``elastic energy" in \citet{Eckart1956}, is the origin of the term ``anelastic," coined by Jule Charney (see \citealt{Ogura1962}). The potential energy term also disappears, which is a direct consequence of the assumption of zero mean mass flux, Equation \eqref{eq:nomassflux}. 

%The latter compressive term $(\prsover/\rhoover^2)\rhoone$ is thus eliminated under the anelastic approximation and we instead identify $\tmpover \entrone$ with the internal energy. 

\section{Conditions for anelastic overshoot}
[THIS SECTION IS A STUB]. What I have so far is that a downflowing plume should have kinetic energy 
\begin{align}
	w^2 \sim g_a H_a \left(\frac{\entrprime}{C_{{\rm p}a}}\right) \sim c_{{\rm s}a}^2 \epsilon
\end{align}
If it descends into a stable stratification with buoyancy frequency
\begin{align}
	N_a^2 =   \frac{g_a}{C_{{\rm p}a}}|\nabla S_a|,
\end{align}
where $|\nabla S_a|$ is a typical value for $|\nabla\tilde{S}|$ in the stable layer. At most, the plume should reach a depth $d$ before it decelerates to $w=0$, with $d$ given by
\begin{align}
	w^2 \sim \left(\frac{\entrprime}{C_{{\rm p}a}}\right)gd \sim \frac{g_a}{C_{{\rm p}a}}|\nabla S_a| d^2 \sim N_a^2 d^2
\end{align}
or 
\begin{align}
	d\sim \frac{w}{N_a}. 
\end{align}
Thus, $|\entrprime|$ should reach a maximum during overshoot of 
\begin{align}
	\max{\left(\frac{\entrprime}{C_{{\rm p}a}}\right)_{\rm stable}} &\sim \left(\frac{|\nabla S_a|}{C_{{\rm p}a}}\right)d \sim \left(\frac{N_a^2}{g_a}\right)\frac{w}{N_a}\nonumber\\
	&\sim \left(\frac{N_a}{g_a}\right)c_{{\rm s}a} \epsilon^{1/2}\sim \left(\frac{N_a}{c_{{\rm s}a}^2/H_a}\right)c_{{\rm s}a} \epsilon^{1/2} = \left(\frac{N_a}{c_{{\rm s}a}/H_a}\right)\epsilon^{1/2}.
\end{align}
We thus expect the thermal perturbations to remain small in the stable layer, provided 
\begin{subequations}
\begin{align}
	\frac{N_a^2}{\omega_{\rm ac}^2} &\lesssim \epsilon,\label{eq:conditionovershoot}\\
	\where \omega_{\rm ac} &\define \frac{c_{{\rm s}a}}{2H_a}
\end{align}
\end{subequations}
is the acoustic cutoff frequency. 

In the solar radiative zone for example, $\omega_{\rm ac}\sim\sn{3}{-2}\ \rm rad\ s^{-1}$ and $N_a\sim \sn{1.4}{-3}\ \rm rad\ s^{-1}$, so condition \eqref{eq:conditionovershoot} should be satisfied if $\epsilon \sim 10^{-3}$. On the other hand, maybe the scale analysis of \citet{Gough1969} breaks down, since buoyantly decelerated flows (i.e., overshoot and g-modes) may have very different dynamical balances than buoyantly accelerated flows (i.e., convection)? So maybe another expansion is necessary that takes into account not only small thermal perturbations, but anisotropic velocity and length scales. 

%Sufficient conditions for conserving energy will likely rest in the numerical precision with which the AnEGG equations \eqref{eq:anegg} are actually solved. 
	\newpage
	%\bibliography{/Users/loren/Desktop/Paper_Library/000_bibtex/library_propstyle, 
		\bibliography{/Users/loren/Desktop/Paper_Library/000_bibtex/library, 
			/Users/loren/Desktop/Paper_Library/000_bibtex/proceedings,
			/Users/loren/Desktop/Paper_Library/000_bibtex/books}
		\bibliographystyle{aasjournal}
	%, therefore getting the properties of internal gravity waves badly wrong.
\end{document}